<!DOCTYPE html>

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width,initial-scale=1" name="viewport" />
    <title>ãƒ–ãƒ¼ãƒˆã‚­ãƒ£ãƒ³ãƒ—ãƒ»ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼</title>
    <meta content="light dark" name="color-scheme" />
    <style>
      :root {
        --bg: #0b1020;
        --card: #111931cc;
        --text: #eaf1ff;
        --muted: #b6c2e1;
        --accent: #6ee7ff;
        --ok: #6ee7a0;
        --warn: #ffd166;
        --danger: #ff6b6b;
        --ring: #2b3657;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        --radius: 18px;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto,
          "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic UI", "Meiryo",
          sans-serif;
        color: var(--text);
        background: radial-gradient(
            1200px 600px at 10% -10%,
            #132042 0%,
            transparent 60%
          ),
          radial-gradient(900px 500px at 110% 20%, #1f2e56 0%, transparent 60%),
          linear-gradient(160deg, #0a0f1c 0%, #0e1426 100%);
        background-attachment: fixed;
      }
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 24px 16px 80px;
      }
      header {
        display: grid;
        gap: 14px;
        align-items: center;
        grid-template-columns: 1fr auto;
        margin-bottom: 18px;
      }
      .title {
        font-size: clamp(22px, 3vw, 32px);
        font-weight: 800;
        letter-spacing: 0.3px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .chipbar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .chip {
        background: linear-gradient(180deg, #1a2344, #131b34);
        border: 1px solid #26325a;
        color: #cfe3ff;
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 13px;
      }
      .grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(12, 1fr);
      }
      .card {
        grid-column: span 12;
        background: linear-gradient(180deg, #121a31, #0e162b);
        backdrop-filter: blur(6px);
        border: 1px solid #243055;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 18px;
      }
      @media (min-width: 900px) {
        .span-7 {
          grid-column: span 7;
        }
        .span-5 {
          grid-column: span 5;
        }
      }
      h2 {
        margin: 0 0 8px;
        font-size: 18px;
      }
      .muted {
        color: var(--muted);
        font-size: 13px;
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .kpi {
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
        margin: 6px 0 12px;
      }
      .pill {
        background: #0b1226;
        border: 1px solid #243055;
        border-radius: 12px;
        padding: 8px 10px;
        font-size: 13px;
        color: #dbe6ff;
      }
      .progress {
        width: 100%;
        height: 12px;
        border-radius: 999px;
        background: #0b1328;
        border: 1px solid #233055;
        overflow: hidden;
      }
      .progress > span {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, #33d1ff, #7af0ff);
        width: 0%;
      }
      .btn {
        border: none;
        border-radius: 12px;
        padding: 10px 14px;
        font-weight: 700;
        cursor: pointer;
        background: linear-gradient(180deg, #27b8ff, #1aa3e6);
        color: #042032;
        box-shadow: 0 6px 18px rgba(39, 184, 255, 0.35);
      }
      .btn.secondary {
        background: linear-gradient(180deg, #2a3357, #1a2242);
        color: #d7e6ff;
        border: 1px solid #2e3a66;
        box-shadow: none;
      }
      .btn.ghost {
        background: transparent;
        border: 1px dashed #2a3968;
        color: #bcd5ff;
      }
      .tag {
        font-size: 12px;
        background: #112044;
        border: 1px solid #26325a;
        padding: 4px 8px;
        border-radius: 999px;
        color: #bfe8ff;
      }
      .list {
        display: grid;
        gap: 10px;
        margin-top: 10px;
      }
      .ex {
        display: grid;
        gap: 10px;
        grid-template-columns: 1fr auto;
        align-items: center;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid #223259;
        background: linear-gradient(180deg, #0f1831, #0c1429);
      }
      .ex .meta {
        font-size: 14px;
      }
      .ex .meta b {
        font-size: 15px;
      }
      .ex .steps {
        font-size: 12px;
        color: #c6d6ff;
      }
      .checkset {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .checkset input {
        accent-color: #33d1ff;
        width: 18px;
        height: 18px;
      }
      .timer {
        display: grid;
        gap: 10px;
        grid-template-columns: 1fr auto;
        align-items: center;
        margin: 12px 0 4px;
      }
      .clock {
        font-variant-numeric: tabular-nums;
        font-size: 28px;
        font-weight: 800;
        letter-spacing: 0.5px;
      }
      .seglist {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .seg {
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid #2a3968;
        background: #0f1937;
        font-size: 12px;
        color: #bfe8ff;
      }
      .note {
        font-size: 12px;
        color: #bcd2ff;
        margin-top: 8px;
      }
      footer {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        gap: 10px;
        justify-content: center;
        align-items: center;
        padding: 10px;
        background: linear-gradient(
          180deg,
          transparent,
          rgba(10, 15, 28, 0.85)
        );
        backdrop-filter: blur(6px);
      }
      .quote {
        font-style: italic;
        color: #cfe3ff;
      }
      .switch {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .switch input {
        width: 42px;
        height: 22px;
      }
      .small {
        font-size: 12px;
      }
    </style>
    <script>
      // --- ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç¢ºèªï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¯¾å¿œï¼‰ ---
      async function ensureLogin() {
        const me = await fetch("/api/me")
          .then((r) => r.json())
          .catch(() => ({ user: null }));

        if (me.user) {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¡¨ç¤º
          updateUserDisplay(me.user);
          return true;
        }

        // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        window.location.href = "/login";
        return false;
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºã®æ›´æ–°
      function updateUserDisplay(username) {
        // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        const header = document.querySelector("header");
        if (header && !document.getElementById("user-info")) {
          const userInfo = document.createElement("div");
          userInfo.id = "user-info";
          userInfo.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="color: var(--accent); font-weight: 600;">ğŸ‘¤ ${username}</span>
              <button onclick="logout()" style="
                background: var(--danger); 
                color: white; 
                border: none; 
                padding: 6px 12px; 
                border-radius: 6px; 
                cursor: pointer;
                font-size: 12px;
              ">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
          `;
          header.appendChild(userInfo);
        }
      }

      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
      async function logout() {
        try {
          await fetch("/api/logout", { method: "POST" });
          window.location.href = "/login";
        } catch (error) {
          console.error("Logout error:", error);
          window.location.href = "/login";
        }
      }

      // ã‚µãƒ¼ãƒãƒ¼ã¸ã€Œä»Šæ—¥ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã€ã‚’é€ã‚‹
      async function pushTodayToServer(entry) {
        try {
          const ok = await ensureLogin();
          if (!ok) return;

          const response = await fetch("/api/logs/upsert", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(entry),
          });

          if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
          }
          // console.log('Server upsert OK');
        } catch (e) {
          // console.warn('Server upsert failed', e);
        }
      }
    </script>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="title">
          ğŸ ãƒ–ãƒ¼ãƒˆã‚­ãƒ£ãƒ³ãƒ—ãƒ»ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ <span class="muted" id="greet"></span>
        </div>
        <div class="chipbar">
          <span class="chip">ä»Šæ—¥ï¼š<b id="today"></b></span>
          <span class="chip">ç›®æ¨™ï¼šæœ‰é…¸ç´ 30åˆ†ï¼‹ç­‹ãƒˆãƒ¬ï¼‹ã‚¹ãƒˆãƒ¬ãƒƒãƒ</span>
          <span class="chip">é€²æ—ï¼š<b id="progressText">0%</b></span>
        </div>
      </header>
      <div class="card" style="margin-bottom: 12px">
        <div class="row" style="justify-content: space-between">
          <div class="row">
            <span class="tag">RPM 70â€“80</span>
            <span class="tag">è² è· 40â€“60%</span>
            <span class="tag">å¿ƒæ‹ 120â€“140ï¼ˆä¼šè©±OKï¼‰</span>
          </div>
          <div class="switch">
            <label class="small"
              ><input id="hiitToggle" type="checkbox" /> HIITãƒ–ãƒ¼ã‚¹ãƒˆï¼ˆä¸­ç›¤5åˆ†
              60â€“70%ï¼‰</label
            >
            <button class="btn secondary" id="resetDay">
              æœ¬æ—¥ã®è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆ
            </button>
          </div>
        </div>
        <div class="progress" style="margin-top: 10px">
          <span id="progressBar"></span>
        </div>
      </div>
      <div class="grid">
        <!-- Aerobike -->
        <section class="card span-7" id="bike">
          <h2>1. æœ‰é…¸ç´ ï¼ˆã‚¨ã‚¢ãƒ­ãƒã‚¤ã‚¯ï¼‰30åˆ†</h2>
          <div class="muted">
            ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—3åˆ† â†’ ä¸­å¼·åº¦22åˆ† â†’ ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³5åˆ†
          </div>
          <div class="timer">
            <div class="clock" id="clock">00:00</div>
            <div class="row">
              <button class="btn" id="start">â–¶ é–‹å§‹</button>
              <button class="btn secondary" id="pause">â¸ ä¸€æ™‚åœæ­¢</button>
              <button class="btn ghost" id="reset">âŸ² ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </div>
          <div class="seglist" id="segments"></div>
          <div class="kpi">
            <div class="pill">å›è»¢æ•°ï¼š<b>70â€“80 rpm</b></div>
            <div class="pill">è² è·ï¼š<b>40â€“60%</b></div>
            <div class="pill">ä¼šè©±ã§ãã‚‹å¼·åº¦</div>
          </div>
          <label class="small"
            ><input id="bikeDone" type="checkbox" /> æœ‰é…¸ç´ 30åˆ† å®Œäº†</label
          >
          <div class="note">
            ãƒ’ãƒ³ãƒˆï¼šåºç›¤ã¯é¼»å‘¼å¸ï¼‹è…¹å¼ã§å¿ƒæ‹ã‚’å®‰å®šã€‚ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹ä¸€å®šã‚’å„ªå…ˆã—ã€è² è·ã§å¾®èª¿æ•´ã€‚
          </div>
        </section>
        <section class="card span-12" id="bgm">
          <h2>ã‚¨ã‚¢ãƒ­ãƒã‚¤ã‚¯ç”¨BGM</h2>
          <div class="ex">
            <div class="meta">
              <b
                ><a
                  href="https://www.youtube.com/watch?v=Hlz_nHElfb4"
                  style="color: inherit; text-decoration: underline"
                  target="_blank"
                  >ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºBGM / EDM</a
                ></b
              >
              <div class="steps">
                ã‚¨ã‚¢ãƒ­ãƒã‚¤ã‚¯ã‚„ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã«ãŠã™ã™ã‚ã®EDMãƒ¡ãƒ‰ãƒ¬ãƒ¼
              </div>
            </div>
          </div>
        </section>

        <!-- Strength -->
        <section class="card span-5" id="strength">
          <h2>2. ç­‹ãƒˆãƒ¬ï¼ˆãƒ•ã‚©ãƒ¼ãƒ é‡è¦–ï¼‰</h2>
          <div class="list">
            <div class="ex">
              <div class="meta">
                <b
                  ><a
                    href="https://www.youtube.com/watch?v=Wjp7V0EK0Zg"
                    style="color: inherit; text-decoration: underline"
                    target="_blank"
                    >2-1. ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ</a
                  ></b
                >
                <span class="tag">15å› Ã— 2ã‚»ãƒƒãƒˆ</span>
                <div class="steps">
                  è‚©å¹…ãƒ»èƒŒç­‹ã¾ã£ã™ãï¼è†ãŒã¤ã¾å…ˆã‚ˆã‚Šå‰ã«å‡ºãªã„ï¼å¤ªã‚‚ã‚‚ãŒåºŠã¨å¹³è¡Œâ†’ã‹ã‹ã¨ã§æŠ¼ã™
                </div>
              </div>
              <div class="checkset">
                <label
                  ><input class="set" data-key="sq-1" type="checkbox" />
                  1</label
                >
                <label
                  ><input class="set" data-key="sq-2" type="checkbox" />
                  2</label
                >
              </div>
            </div>
            <div class="ex">
              <div class="meta">
                <b
                  ><a
                    href="https://www.youtube.com/watch?v=IdQESpQE9ew"
                    style="color: inherit; text-decoration: underline"
                    target="_blank"
                    >2-2. ãƒ—ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—</a
                  ></b
                >
                <span class="tag">10â€“15å› Ã— 2ã‚»ãƒƒãƒˆ</span>
                <div class="steps">
                  æ‰‹å¹…ã‚„ã‚„åºƒã‚ï¼é ­ã€œã‹ã‹ã¨ä¸€ç›´ç·šï¼ˆè†ã¤ãå¯ï¼‰ï¼èƒ¸ã‚’åºŠã‚¹ãƒ¬ã‚¹ãƒ¬ã¾ã§
                </div>
              </div>
              <div class="checkset">
                <label
                  ><input class="set" data-key="pu-1" type="checkbox" />
                  1</label
                >
                <label
                  ><input class="set" data-key="pu-2" type="checkbox" />
                  2</label
                >
              </div>
            </div>
            <div class="ex">
              <div class="meta">
                <b
                  ><a
                    href="https://www.youtube.com/watch?v=UgkU2S8VUX4"
                    style="color: inherit; text-decoration: underline"
                    target="_blank"
                    >2-3. ãƒ—ãƒ©ãƒ³ã‚¯</a
                  ></b
                >
                <span class="tag">30ç§’ Ã— 3ã‚»ãƒƒãƒˆ</span>
                <div class="steps">
                  è‚˜ã¯è‚©ã®çœŸä¸‹ï¼é ­ã€œã‹ã‹ã¨ä¸€ç›´ç·šï¼è…¹åœ§ã§è…°ã‚’è½ã¨ã•ãªã„
                </div>
              </div>
              <div class="checkset">
                <label
                  ><input class="set" data-key="pl-1" type="checkbox" />
                  1</label
                >
                <label
                  ><input class="set" data-key="pl-2" type="checkbox" />
                  2</label
                >
                <label
                  ><input class="set" data-key="pl-3" type="checkbox" />
                  3</label
                >
                <button class="btn ghost small" id="plank30">
                  â–¶ 30ç§’ã‚¿ã‚¤ãƒãƒ¼
                </button>
              </div>
            </div>
            <div class="ex">
              <div class="meta">
                <b
                  ><a
                    href="https://www.youtube.com/watch?v=FvU7izWY358"
                    style="color: inherit; text-decoration: underline"
                    target="_blank"
                    >2-4. ãƒãƒ¼ãƒ‰ãƒ‰ãƒƒã‚°</a
                  ></b
                >
                <span class="tag">å·¦å³10å›ãšã¤ Ã— 2ã‚»ãƒƒãƒˆ</span>
                <div class="steps">
                  å››ã¤ã‚“é€™ã„ï¼åå¯¾ã®æ‰‹è¶³ã‚’ã¾ã£ã™ãï¼è…°é«˜ã‚’å¤‰ãˆãšä½“å¹¹å®‰å®š
                </div>
              </div>
              <div class="checkset">
                <label
                  ><input class="set" data-key="bd-1" type="checkbox" />
                  1</label
                >
                <label
                  ><input class="set" data-key="bd-2" type="checkbox" />
                  2</label
                >
              </div>
            </div>
            <div class="ex">
              <div class="meta">
                <b
                  ><a
                    href="https://www.youtube.com/watch?v=FdEmJ3wPC_Y"
                    style="color: inherit; text-decoration: underline"
                    target="_blank"
                    >2-5. ãƒ’ãƒƒãƒ—ãƒªãƒ•ãƒˆ</a
                  ></b
                >
                <span class="tag">15å› Ã— 2ã‚»ãƒƒãƒˆ</span>
                <div class="steps">
                  ä»°å‘ã‘è†ç«‹ã¦ï¼è‚©ã€œè†ä¸€ç›´ç·šï¼é ‚ç‚¹ã§1ç§’æ­¢ã‚ã¦ä¸‹ã‚ã™
                </div>
              </div>
              <div class="checkset">
                <label
                  ><input class="set" data-key="hl-1" type="checkbox" />
                  1</label
                >
                <label
                  ><input class="set" data-key="hl-2" type="checkbox" />
                  2</label
                >
              </div>
            </div>
            <div class="ex">
              <div class="meta">
                <b
                  ><a
                    href="https://www.youtube.com/shorts/Nzbrmw71HdY"
                    style="color: inherit; text-decoration: underline"
                    target="_blank"
                    >2-6. ãƒã‚¦ãƒ³ãƒ†ãƒ³ã‚¯ãƒ©ã‚¤ãƒãƒ¼</a
                  ></b
                >
                <span class="tag">å·¦å³20å›ãšã¤ Ã— 2ã‚»ãƒƒãƒˆ</span>
                <div class="steps">
                  ãƒ—ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—å§¿å‹¢ï¼è†ã‚’èƒ¸ã«å¼•ãå¯„ã›ç´ æ—©ãå…¥æ›¿ï¼è…°ã®ä¸Šä¸‹ã¯æœ€å°ã«
                </div>
              </div>
              <div class="checkset">
                <label
                  ><input class="set" data-key="mc-1" type="checkbox" />
                  1</label
                >
                <label
                  ><input class="set" data-key="mc-2" type="checkbox" />
                  2</label
                >
              </div>
            </div>
            <label class="small"
              ><input id="strengthDone" type="checkbox" /> ç­‹ãƒˆãƒ¬ å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼
              å®Œäº†</label
            >
          </div>
        </section>
        <!-- Stretch -->
        <section class="card span-12" id="stretch">
          <h2>3. ã‚¹ãƒˆãƒ¬ãƒƒãƒï¼ˆ2ã€œ3åˆ†ï¼‰</h2>
          <div class="list">
            <label class="small"
              ><input class="str" data-key="st-thigh" type="checkbox" />
              å¤ªã‚‚ã‚‚å‰å¾Œ</label
            >
            <label class="small"
              ><input class="str" data-key="st-calf" type="checkbox" />
              ãµãã‚‰ã¯ã</label
            >
            <label class="small"
              ><input class="str" data-key="st-shoulder" type="checkbox" />
              è‚©ãƒ»èƒŒä¸­</label
            >
            <label class="small"
              ><input class="str" data-key="st-chest" type="checkbox" />
              èƒ¸</label
            >
            <div class="note">
              åå‹•ã‚’ã¤ã‘ãšã€æ·±å‘¼å¸ã—ãªãŒã‚‰15â€“20ç§’ã‚­ãƒ¼ãƒ—ã‚’æ•°ã‚»ãƒƒãƒˆã€‚
            </div>
            <label class="small"
              ><input id="stretchDone" type="checkbox" /> ã‚¹ãƒˆãƒ¬ãƒƒãƒ å®Œäº†</label
            >
          </div>
        </section>
        <section class="card span-12" id="journal">
          <h2>4. æ—¥æ¬¡ãƒ­ã‚°ï¼ˆä¿å­˜ãƒ»å±¥æ­´ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰</h2>
          <div
            class="row"
            style="align-items: stretch; gap: 12px; margin: 8px 0"
          >
            <textarea
              id="note"
              placeholder="ä»Šæ—¥ã®ãƒ¡ãƒ¢ï¼ˆä½“èª¿ã€è² è·ã€æ°—ã¥ãç­‰ï¼‰"
              style="
                flex: 1;
                min-height: 70px;
                border-radius: 12px;
                border: 1px solid #223259;
                background: #0f1831;
                color: #eaf1ff;
                padding: 10px;
              "
            ></textarea>
            <div style="display: flex; flex-direction: column; gap: 8px">
              <button class="btn" id="saveLog">ğŸ’¾ ä»Šæ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜</button>
              <button class="btn secondary" id="exportCsv">
                ğŸ“¤ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
              </button>
              <button class="btn ghost" id="clearAllLogs">
                ğŸ—‘ ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤
              </button>
            </div>
          </div>
          <div class="row" style="gap: 8px; margin: 6px 0 0">
            <input
              accept="application/json"
              id="importJsonFile"
              style="display: none"
              type="file"
            />
            <button class="btn secondary" id="exportJson">
              ğŸ§° JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
            </button>
            <button class="btn ghost" id="importJson">ğŸ“¥ JSONèª­ã¿è¾¼ã¿</button>
          </div>
          <div class="list">
            <div class="small muted">
              â€» ä¿å­˜ã™ã‚‹ã¨ä¸‹ã®å±¥æ­´ã«è¿½åŠ ã•ã‚Œã¾ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ï¼‰ã€‚
            </div>
            <div
              style="
                overflow: auto;
                border: 1px solid #223259;
                border-radius: 12px;
              "
            >
              <table
                id="logTable"
                style="width: 100%; border-collapse: collapse; font-size: 13px"
              >
                <thead>
                  <tr style="background: #0b1328">
                    <th
                      style="
                        padding: 8px;
                        text-align: left;
                        border-bottom: 1px solid #223259;
                      "
                    >
                      æ—¥æ™‚
                    </th>
                    <th
                      style="
                        padding: 8px;
                        text-align: left;
                        border-bottom: 1px solid #223259;
                      "
                    >
                      é€²æ—(%)
                    </th>
                    <th
                      style="
                        padding: 8px;
                        text-align: left;
                        border-bottom: 1px solid #223259;
                      "
                    >
                      æœ‰é…¸ç´ 
                    </th>
                    <th
                      style="
                        padding: 8px;
                        text-align: left;
                        border-bottom: 1px solid #223259;
                      "
                    >
                      ã‚¹ã‚¯
                    </th>
                    <th
                      style="
                        padding: 8px;
                        text-align: left;
                        border-bottom: 1px solid #223259;
                      "
                    >
                      è…•ç«‹
                    </th>
                    <th
                      style="
                        padding: 8px;
                        text-align: left;
                        border-bottom: 1px solid #223259;
                      "
                    >
                      ãƒ—ãƒ©
                    </th>
                    <th
                      style="
                        padding: 8px;
                        text-align: left;
                        border-bottom: 1px solid #223259;
                      "
                    >
                      BD
                    </th>
                    <th
                      style="
                        padding: 8px;
                        text-align: left;
                        border-bottom: 1px solid #223259;
                      "
                    >
                      HL
                    </th>
                    <th
                      style="
                        padding: 8px;
                        text-align: left;
                        border-bottom: 1px solid #223259;
                      "
                    >
                      MC
                    </th>
                    <th
                      style="
                        padding: 8px;
                        text-align: left;
                        border-bottom: 1px solid #223259;
                      "
                    >
                      ã‚¹ãƒˆãƒ¬ãƒƒãƒ
                    </th>
                    <th
                      style="
                        padding: 8px;
                        text-align: left;
                        border-bottom: 1px solid #223259;
                      "
                    >
                      ãƒ¡ãƒ¢
                    </th>
                    <th
                      style="
                        padding: 8px;
                        text-align: left;
                        border-bottom: 1px solid #223259;
                      "
                    >
                      æ“ä½œ
                    </th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </div>
    <footer>
      <span class="quote" id="quote"
        >ã€Œæœ€åˆã®ä¸€æ­©ãŒã€ã„ã¡ã°ã‚“ä½“æ¸©ã‚’ä¸Šã’ã‚‹ã€‚ã€</span
      >
      <span class="chip" id="dailyBadge"
        >ä»Šæ—¥ã®é€£ç¶šæ—¥æ•°ï¼š<b id="streak">0</b> ğŸ”¥</span
      >
    </footer>
    <script>
      (function () {
        // === Utilities ===
        const $ = (s) => document.querySelector(s);
        const $$ = (s) => Array.from(document.querySelectorAll(s));
        const todayStr = new Date().toLocaleDateString("ja-JP", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
        });
        const keyBase = () => new Date().toISOString().slice(0, 10); // YYYY-MM-DD
        const LSKEY = (suffix) => `bootcamp.${suffix}`;

        const elToday = $("#today");
        elToday.textContent = todayStr;
        const hour = new Date().getHours();
        $("#greet").textContent =
          hour < 5
            ? "æ—©æœã‚»ãƒƒã‚·ãƒ§ãƒ³"
            : hour < 12
            ? "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™"
            : hour < 18
            ? "ã“ã‚“ã«ã¡ã¯"
            : "ã“ã‚“ã°ã‚“ã¯";

        // === Quotes ===
        const quotes = [
          "å°ã•ãå§‹ã‚ã¦ã€å¤§ããç¶šã‘ã‚‹ã€‚",
          "æ˜¨æ—¥ã‚ˆã‚Š1mmå‰ã¸ã€‚",
          "è¿·ã†ãªã‚‰ã€ã‚„ã£ã¦ã‹ã‚‰è¿·ã†ã€‚",
          "ç¶™ç¶šã¯æ‰èƒ½ã‚’è¶Šãˆã‚‹ã€‚",
          "ãƒ•ã‚©ãƒ¼ãƒ ã¯æ­£ç¾©ã€‚å›æ•°ã¯çµæœã€‚",
        ];
        function rotateQuote() {
          $("#quote").textContent = `ã€Œ${
            quotes[Math.floor(Math.random() * quotes.length)]
          }ã€`;
        }
        setInterval(rotateQuote, 12000);

        // === Progress ===
        function getState() {
          const k = LSKEY(keyBase() + ".state");
          return JSON.parse(localStorage.getItem(k) || "{}");
        }
        function setState(state) {
          const k = LSKEY(keyBase() + ".state");
          localStorage.setItem(k, JSON.stringify(state));
        }

        // ã‚»ãƒƒãƒˆæ•°ã®ç®¡ç†
        function getSets() {
          const state = getState();
          return state.sets || {};
        }
        function setSets(sets) {
          const state = getState();
          state.sets = sets;
          setState(state);
        }

        // ã‚¹ãƒˆãƒ¬ãƒƒãƒéƒ¨ä½ã®ç®¡ç†
        function getStretchParts() {
          const state = getState();
          return state.stretchParts || {};
        }
        function setStretchParts(parts) {
          const state = getState();
          state.stretchParts = parts;
          setState(state);
        }

        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã®ç®¡ç†
        function getJournal() {
          return JSON.parse(localStorage.getItem(LSKEY("journal")) || "[]");
        }
        function setJournal(journal) {
          localStorage.setItem(LSKEY("journal"), JSON.stringify(journal));
        }

        function mark(name, value) {
          console.log("mark called with:", name, value); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
          const s = getState();
          console.log("Current state before mark:", s); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
          s[name] = value;
          setState(s);
          console.log("State after mark:", s); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
          updateProgress();
        }

        function updateProgress() {
          console.log("updateProgress called"); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°

          // Auto-save hook: whenever progress recalculates, schedule snapshot
          scheduleAutoSave();

          // 1) çŠ¶æ…‹ï¼ˆlocalStorageï¼‰ã‹ã‚‰å–å¾—
          const s = getState();
          let bike = !!s.bikeDone;
          let strength = !!s.strengthDone;
          let stretch = !!s.stretchDone;
          let sets = getSets();
          let stretchParts = getStretchParts();

          // 2) ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šDOMã®ç¾åœ¨å€¤ã‚’å„ªå…ˆï¼ˆã‚¤ãƒ™ãƒ³ãƒˆæœªæ¥ç¶šã§ã‚‚å‹•ãï¼‰
          const bikeEl = document.getElementById("bikeDone");
          const strEl = document.getElementById("strengthDone");
          const stEl = document.getElementById("stretchDone");
          if (bikeEl) bike = bikeEl.checked;
          if (strEl) strength = strEl.checked;
          if (stEl) stretch = stEl.checked;

          // ã‚»ãƒƒãƒˆ/ã‚¹ãƒˆãƒ¬ãƒƒãƒéƒ¨ä½ãŒæœªå®šç¾©ãªã‚‰ç©ºæ‰±ã„
          if (!sets || typeof sets !== "object") sets = {};
          if (!stretchParts || typeof stretchParts !== "object")
            stretchParts = {};

          console.log("State/DOM merged:", {
            bike,
            strength,
            stretch,
            sets,
            stretchParts,
          });

          // ãƒ¡ã‚¤ãƒ³é …ç›®ã®å®Œäº†ç‡ (70%)
          const big =
            ((bike ? 1 : 0) + (strength ? 1 : 0) + (stretch ? 1 : 0)) / 3;

          // è©³ç´°é …ç›®ã®å®Œäº†ç‡ (30%)
          const setValues = Object.values(sets).filter((v) => Number(v) > 0);
          const stretchValues = Object.values(stretchParts).filter(
            (v) => v === true
          );
          const microTotal = 13; // 6ã‚»ãƒƒãƒˆ + 7ã‚¹ãƒˆãƒ¬ãƒƒãƒéƒ¨ä½
          const microDone = setValues.length + stretchValues.length;
          const microRate = microTotal > 0 ? microDone / microTotal : 0;

          const pct = Math.round(100 * (0.7 * big + 0.3 * microRate));

          console.log("Progress calculated:", pct + "%"); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°

          const progressBar = $("#progressBar");
          const progressText = $("#progressText");
          if (progressBar) progressBar.style.width = pct + "%";
          if (progressText) progressText.textContent = pct + "%";

          // streak
          const streak = Number(localStorage.getItem(LSKEY("streak")) || "0");
          const streakEl = $("#streak");
          if (streakEl) streakEl.textContent = streak;
        }

        // === Streak handling ===
        (function () {
          const last = localStorage.getItem(LSKEY("lastOpen"));
          const today = keyBase();
          if (last !== today) {
            // new day -> if yesterday had any completion, keep streak; otherwise maybe break.
            const yKey = new Date(Date.now() - 86400000)
              .toISOString()
              .slice(0, 10);
            const yState = JSON.parse(
              localStorage.getItem(`bootcamp.${yKey}.state`) || "{}"
            );
            const had =
              yState.bikeDone || yState.strengthDone || yState.stretchDone;
            let streak = Number(localStorage.getItem(LSKEY("streak")) || "0");
            if (had) {
              streak = streak + 1;
            } else {
              streak = 0;
            }
            localStorage.setItem(LSKEY("streak"), String(streak));
            localStorage.setItem(LSKEY("lastOpen"), today);
          }
        })();

        // === Aerobike Timer ===
        const segmentsEl = $("#segments");
        const hiitToggle = $("#hiitToggle");

        function baseSegments() {
          return [
            { name: "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—", mins: 3, tip: "å¿ƒæ‹100â€“110" },
            { name: "ä¸­å¼·åº¦", mins: 22, tip: "å¿ƒæ‹120â€“140" },
            { name: "ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³", mins: 5, tip: "è»½ã‚" },
          ];
        }
        function withHIIT() {
          return [
            { name: "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—", mins: 3, tip: "å¿ƒæ‹100â€“110" },
            { name: "ä¸­å¼·åº¦", mins: 8, tip: "120â€“140" },
            { name: "HIIT", mins: 5, tip: "è² è·60â€“70%" },
            { name: "ä¸­å¼·åº¦", mins: 9, tip: "120â€“140" },
            { name: "ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³", mins: 5, tip: "è»½ã‚" },
          ];
        }
        function renderSegments() {
          const arr = hiitToggle.checked ? withHIIT() : baseSegments();
          segmentsEl.innerHTML = "";
          arr.forEach((seg, i) => {
            const div = document.createElement("div");
            div.className = "seg";
            div.dataset.idx = i;
            div.innerHTML = `<b>${seg.name}</b>ï¼š${seg.mins}åˆ† <span class="muted">(${seg.tip})</span>`;
            segmentsEl.appendChild(div);
          });
        }
        hiitToggle.addEventListener("change", () => {
          renderSegments();
          resetTimer();
        });
        renderSegments();

        let timer = null,
          totalSec = 0,
          plan = [],
          cursor = 0,
          segRemain = 0,
          running = false;

        function loadPlan() {
          plan = (hiitToggle.checked ? withHIIT() : baseSegments()).map(
            (s) => ({ ...s, sec: s.mins * 60 })
          );
          totalSec = plan.reduce((a, b) => a + b.sec, 0);
          cursor = 0;
          segRemain = plan[0].sec;
          highlightSeg();
          $("#clock").textContent = fmt(totalSec);
        }
        function fmt(sec) {
          const m = Math.floor(sec / 60),
            s = sec % 60;
          return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
        }
        function highlightSeg() {
          $$("#segments .seg").forEach((el, i) => {
            el.style.borderColor = i === cursor ? "#33d1ff" : "#2a3968";
            el.style.boxShadow =
              i === cursor ? "0 0 0 1px #33d1ff inset" : "none";
          });
        }
        function beep() {
          try {
            const a = new (window.AudioContext || window.webkitAudioContext)();
            const o = a.createOscillator(),
              g = a.createGain();
            o.type = "sine";
            o.frequency.value = 880;
            o.connect(g);
            g.connect(a.destination);
            g.gain.setValueAtTime(0.001, a.currentTime);
            g.gain.exponentialRampToValueAtTime(0.2, a.currentTime + 0.01);
            o.start();
            setTimeout(() => {
              g.gain.exponentialRampToValueAtTime(0.001, a.currentTime + 0.18);
              o.stop(a.currentTime + 0.2);
            }, 180);
          } catch (e) {}
        }
        function tick() {
          if (!running) return;
          if (totalSec <= 0) {
            finishBike();
            return;
          }
          totalSec--;
          segRemain--;
          $("#clock").textContent = fmt(totalSec);
          if (segRemain <= 0) {
            cursor++;
            if (cursor < plan.length) {
              segRemain = plan[cursor].sec;
              highlightSeg();
              beep();
            }
          }
        }
        function startTimer() {
          if (running) return;
          if (totalSec <= 0) loadPlan();
          running = true;
          timer = setInterval(tick, 1000);
        }
        function pauseTimer() {
          running = false;
          if (timer) clearInterval(timer);
        }
        function resetTimer() {
          pauseTimer();
          loadPlan();
        }
        function finishBike() {
          pauseTimer();
          $("#clock").textContent = "å®Œäº†ï¼";
          $("#bikeDone").checked = true;
          mark("bikeDone", true);
          beep();
          setTimeout(beep, 220);
        }

        $("#start").addEventListener("click", startTimer);
        $("#pause").addEventListener("click", pauseTimer);
        $("#reset").addEventListener("click", resetTimer);
        $("#bikeDone").addEventListener("change", (e) =>
          mark("bikeDone", e.target.checked)
        );
        loadPlan();

        // === Plank 30s helper ===
        $("#plank30").addEventListener("click", () => {
          const btn = $("#plank30");
          btn.disabled = true;
          btn.textContent = "â³ 30ç§’";
          let s = 30;
          const t = setInterval(() => {
            s--;
            btn.textContent = `â³ ${s}ç§’`;
            if (s <= 0) {
              clearInterval(t);
              beep();
              btn.textContent = "â–¶ 30ç§’ã‚¿ã‚¤ãƒãƒ¼";
              btn.disabled = false;
            }
          }, 1000);
        });

        // === Strength / Stretch check handlers ===
        function collectSets() {
          const s = getState();
          const keys = [
            "sq-1",
            "sq-2",
            "pu-1",
            "pu-2",
            "pl-1",
            "pl-2",
            "pl-3",
            "bd-1",
            "bd-2",
            "hl-1",
            "hl-2",
            "mc-1",
            "mc-2",
          ];
          const arr = keys.map((k) => !!s[`set.${k}`]);
          s.sets = arr;
          setState(s);
        }
        $$(".set").forEach((ch) => {
          const key = `set.${ch.dataset.key}`;
          ch.checked = !!getState()[key];
          ch.addEventListener("change", (e) => {
            const s = getState();
            s[key] = e.target.checked;
            setState(s);
            collectSets();
            updateProgress();
          });
        });
        $("#strengthDone").checked = !!getState().strengthDone;
        $("#strengthDone").addEventListener("change", (e) =>
          mark("strengthDone", e.target.checked)
        );

        function collectStretch() {
          const s = getState();
          const keys = ["st-thigh", "st-calf", "st-shoulder", "st-chest"];
          s.stretchParts = keys.map((k) => !!s[`str.${k}`]);
          setState(s);
        }
        $$(".str").forEach((ch) => {
          const key = `str.${ch.dataset.key}`;
          ch.checked = !!getState()[key];
          ch.addEventListener("change", (e) => {
            const s = getState();
            s[key] = e.target.checked;
            setState(s);
            collectStretch();
            updateProgress();
          });
        });
        $("#stretchDone").checked = !!getState().stretchDone;
        $("#stretchDone").addEventListener("change", (e) =>
          mark("stretchDone", e.target.checked)
        );

        collectSets();
        collectStretch();
        updateProgress();

        // === Reset today ===
        $("#resetDay").addEventListener("click", () => {
          if (!confirm("æœ¬æ—¥ã®è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
          localStorage.removeItem(LSKEY(keyBase() + ".state"));
          // Uncheck all
          $$(".set, .str").forEach((ch) => (ch.checked = false));
          $("#bikeDone").checked = false;
          $("#strengthDone").checked = false;
          $("#stretchDone").checked = false;
          updateProgress();
        });

        // === Journal (Daily Logs) ===
        function LS_JOURNAL_KEY() {
          return LSKEY("journal");
        }

        function getJournal() {
          return JSON.parse(localStorage.getItem(LS_JOURNAL_KEY()) || "[]");
        }
        function setJournal(arr) {
          localStorage.setItem(LS_JOURNAL_KEY(), JSON.stringify(arr));
        }

        function progressValue() {
          // Recalculate using the same logic as updateProgress()
          const s = getState();
          const sets = getSets();
          const stretchParts = getStretchParts();

          // ãƒ¡ã‚¤ãƒ³é …ç›®ã®å®Œäº†ç‡ (70%)
          const big =
            ((s.bikeDone ? 1 : 0) +
              (s.strengthDone ? 1 : 0) +
              (s.stretchDone ? 1 : 0)) /
            3;

          // è©³ç´°é …ç›®ã®å®Œäº†ç‡ (30%)
          const setValues = Object.values(sets).filter((v) => v > 0);
          const stretchValues = Object.values(stretchParts).filter(
            (v) => v === true
          );
          const microTotal = 13; // 6ã‚»ãƒƒãƒˆ + 7ã‚¹ãƒˆãƒ¬ãƒƒãƒéƒ¨ä½
          const microDone = setValues.length + stretchValues.length;
          const microRate = microTotal > 0 ? microDone / microTotal : 0;

          return Math.round(100 * (0.7 * big + 0.3 * microRate));
        }

        function summarizeSets() {
          const s = getState();
          const m = {
            sq: (s.sets || []).slice(0, 2), // sq-1, sq-2
            pu: (s.sets || []).slice(2, 4), // pu-1, pu-2
            pl: (s.sets || []).slice(4, 7), // pl-1..3
            bd: (s.sets || []).slice(7, 9), // bd-1..2
            hl: (s.sets || []).slice(9, 11), // hl-1..2
            mc: (s.sets || []).slice(11, 13), // mc-1..2
          };
          const sum = (arr) => arr.reduce((a, b) => a + (b ? 1 : 0), 0);
          return {
            sq: sum(m.sq),
            pu: sum(m.pu),
            pl: sum(m.pl),
            bd: sum(m.bd),
            hl: sum(m.hl),
            mc: sum(m.mc),
          };
        }

        function summarizeToday() {
          const s = getState();
          const sets = getSets();
          const stretchParts = getStretchParts();

          return {
            date: new Date().toISOString(),
            dateKey: keyBase(),
            progress: progressValue(),
            bikeDone: !!s.bikeDone,
            strengthDone: !!s.strengthDone,
            stretchDone: !!s.stretchDone,
            hiit: !!document.querySelector("#hiitToggle")?.checked,
            sets: {
              sq: sets.sq || 0,
              pu: sets.pu || 0,
              pl: sets.pl || 0,
              bd: sets.bd || 0,
              hl: sets.hl || 0,
              mc: sets.mc || 0,
            },
            stretchParts: Object.values(stretchParts).filter(Boolean).length,
            note: document.querySelector("#note")?.value || "",
          };
        }

        function renderLogTable() {
          const tbody = document.querySelector("#logTable tbody");
          if (!tbody) return;
          tbody.innerHTML = "";

          const logs = (getJournal() || []).slice().sort((a, b) => {
            // dateKey desc, fallback to date
            const ak = a.dateKey || (a.date ? a.date.slice(0, 10) : "");
            const bk = b.dateKey || (b.date ? b.date.slice(0, 10) : "");
            if (ak === bk) return (b.date || "").localeCompare(a.date || "");
            return bk.localeCompare(ak);
          });

          if (logs.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="12" style="padding:10px; color:#9fb2d9;">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ã®ã€Œä»Šæ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜ã€ã‚’æŠ¼ã™ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</td>`;
            tbody.appendChild(tr);
            return;
          }

          logs.forEach((lg) => {
            const tr = document.createElement("tr");
            tr.style.borderBottom = "1px solid #223259";
            const dt = new Date(lg.date || `${lg.dateKey}T00:00:00`);
            const dtStr = isNaN(dt.getTime())
              ? lg.dateKey || "-"
              : dt.toLocaleString("ja-JP", {
                  year: "numeric",
                  month: "2-digit",
                  day: "2-digit",
                  hour: "2-digit",
                  minute: "2-digit",
                });
            tr.innerHTML = `
              <td style="padding:8px;">${dtStr}</td>
              <td style="padding:8px;">${lg.progress ?? "-"}</td>
              <td style="padding:8px;">${
                lg.bikeDone ? (lg.hiit ? "æœ‰é…¸ç´ +HIIT" : "æœ‰é…¸ç´ ") : "-"
              }</td>
              <td style="padding:8px;">${lg.sets?.sq ?? 0}</td>
              <td style="padding:8px;">${lg.sets?.pu ?? 0}</td>
              <td style="padding:8px;">${lg.sets?.pl ?? 0}</td>
              <td style="padding:8px;">${lg.sets?.bd ?? 0}</td>
              <td style="padding:8px;">${lg.sets?.hl ?? 0}</td>
              <td style="padding:8px;">${lg.sets?.mc ?? 0}</td>
              <td style="padding:8px;">${lg.stretchDone ? "âœ”" : "-"}</td>
              <td style="padding:8px; max-width:320px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${(
                lg.note || ""
              ).replace(/"/g, "&quot;")}">${lg.note || ""}</td>
              <td style="padding:8px;"><button class="btn ghost small" data-datekey="${
                lg.dateKey
              }">å‰Šé™¤</button></td>
            `;
            tr.querySelector("button").addEventListener("click", (e) => {
              const key = e.target.dataset.datekey;
              const list = getJournal();
              const idx = list.findIndex((x) => (x.dateKey || "") === key);
              if (idx >= 0 && confirm("ã“ã®æ—¥ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                list.splice(idx, 1);
                setJournal(list);
                renderLogTable();
              }
            });
            tbody.appendChild(tr);
          });
        }

        function saveTodayLogDeprecated_DO_NOT_USE() {
          const entry = summarizeToday();
          const logs = getJournal();
          logs.push(entry);
          setJournal(logs);
          renderLogTable();
          alert("ä»Šæ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
        }

        function exportCsv() {
          const logs = getJournal();
          const header = [
            "datetime",
            "dateKey",
            "progress",
            "bikeDone",
            "hiit",
            "strengthDone",
            "stretchDone",
            "sq_sets",
            "pu_sets",
            "pl_sets",
            "bd_sets",
            "hl_sets",
            "mc_sets",
            "stretchParts",
            "note",
          ];
          const rows = logs.map((lg) => [
            lg.date,
            lg.dateKey,
            lg.progress,
            lg.bikeDone,
            lg.hiit,
            lg.strengthDone,
            lg.stretchDone,
            lg.sets?.sq ?? 0,
            lg.sets?.pu ?? 0,
            lg.sets?.pl ?? 0,
            lg.sets?.bd ?? 0,
            lg.sets?.hl ?? 0,
            lg.sets?.mc ?? 0,
            lg.stretchParts ?? 0,
            (lg.note || "").replace(/\r?\n/g, " "),
          ]);
          const csv = [header.join(","), ...rows.map((r) => r.join(","))].join(
            "\\n"
          );
          const blob = new Blob([csv], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `bootcamp_journal_${keyBase()}.csv`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }

        function clearAllLogs() {
          if (!confirm("ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
          setJournal([]);
          renderLogTable();
        }

        // Bind buttons after DOM ready
        window.addEventListener("DOMContentLoaded", async () => {
          console.log("DOM loaded, initializing..."); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°

          // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
          await ensureLogin();

          // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¡¨ç¤º
          initializeToday();

          // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ãƒ†ã‚¹ãƒˆ
          testProgressBar();

          // åŸºæœ¬çš„ãªã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
          setupEventListeners();

          // é€²æ—çŠ¶æ…‹ã‚’å¾©å…ƒãƒ»æ›´æ–°
          restoreState();
          updateProgress();

          // ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤º
          renderLogTable();

          // è¿½åŠ ãƒœã‚¿ãƒ³ã®ãƒã‚¤ãƒ³ãƒ‰ï¼ˆJSON import/exportï¼‰
          const expJ = document.getElementById("exportJson");
          const impJ = document.getElementById("importJson");
          const file = document.getElementById("importJsonFile");
          if (expJ) expJ.addEventListener("click", exportJson);
          if (impJ) impJ.addEventListener("click", () => file && file.click());
          if (file)
            file.addEventListener("change", (e) => {
              if (e.target.files && e.target.files[0])
                importJson(e.target.files[0]);
            });
        });

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ãƒ†ã‚¹ãƒˆé–¢æ•°
        function testProgressBar() {
          console.log("Testing progress bar..."); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
          const progressBar = document.getElementById("progressBar");
          const progressText = document.getElementById("progressText");

          if (progressBar) {
            console.log("ProgressBar found, setting test width"); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
            progressBar.style.width = "50%";
            progressBar.style.backgroundColor = "#33d1ff"; // è‰²ã‚’ç¢ºå®Ÿã«è¨­å®š
          } else {
            console.error("ProgressBar element not found!"); // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
          }

          if (progressText) {
            console.log("ProgressText found, setting test text"); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
            progressText.textContent = "50%";
          } else {
            console.error("ProgressText element not found!"); // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
          }

          // 3ç§’å¾Œã«å®Ÿéš›ã®updateProgressã‚’å‘¼ã¶
          setTimeout(() => {
            console.log("Calling updateProgress after test...");
            updateProgress();
          }, 3000);
        }

        // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šæ‰‹å‹•ã§ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚’å¤‰æ›´ã™ã‚‹é–¢æ•°ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä½¿ç”¨å¯èƒ½ï¼‰
        window.setTestProgress = function (percent) {
          const progressBar = document.getElementById("progressBar");
          const progressText = document.getElementById("progressText");
          if (progressBar) progressBar.style.width = percent + "%";
          if (progressText) progressText.textContent = percent + "%";
          console.log("Manual progress set to:", percent + "%");
        }; // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¡¨ç¤º
        function initializeToday() {
          const today = new Date();
          const todayStr = today.toLocaleDateString("ja-JP", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            weekday: "short",
          });
          const todayElement = document.getElementById("today");
          if (todayElement) {
            todayElement.textContent = todayStr;
          }
        }

        // åŸºæœ¬çš„ãªã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        function setupEventListeners() {
          console.log("Setting up event listeners..."); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°

          // ä¿å­˜ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
          const saveBtn = document.getElementById("saveLog");
          const expBtn = document.getElementById("exportCsv");
          const clrBtn = document.getElementById("clearAllLogs");

          console.log("Buttons found:", { saveBtn, expBtn, clrBtn }); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°

          if (saveBtn)
            saveBtn.addEventListener("click", () => {
              console.log("Save button clicked"); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
              saveTodaySnapshot(false);
            });
          if (expBtn)
            expBtn.addEventListener("click", () => {
              console.log("Export button clicked"); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
              exportCsv();
            });
          if (clrBtn)
            clrBtn.addEventListener("click", () => {
              console.log("Clear button clicked"); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
              clearAllLogs();
            });

          // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
          const bikeDone = document.getElementById("bikeDone");
          const strengthDone = document.getElementById("strengthDone");
          const stretchDone = document.getElementById("stretchDone");

          console.log("Checkboxes found:", {
            bikeDone,
            strengthDone,
            stretchDone,
          }); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°

          if (bikeDone)
            bikeDone.addEventListener("change", () => {
              console.log("Bike checkbox changed:", bikeDone.checked); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
              mark("bikeDone", bikeDone.checked);
            });
          if (strengthDone)
            strengthDone.addEventListener("change", () => {
              console.log("Strength checkbox changed:", strengthDone.checked); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
              mark("strengthDone", strengthDone.checked);
            });
          if (stretchDone)
            stretchDone.addEventListener("change", () => {
              console.log("Stretch checkbox changed:", stretchDone.checked); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
              mark("stretchDone", stretchDone.checked);
            });

          // ã‚»ãƒƒãƒˆæ•°å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
          ["sq", "pu", "pl", "bd", "hl", "mc"].forEach((name) => {
            const input = document.getElementById(name);
            if (input) {
              input.addEventListener("input", () => {
                const sets = getSets();
                sets[name] = parseInt(input.value) || 0;
                setSets(sets);
                updateProgress();
              });
            }
          });

          // ã‚¹ãƒˆãƒ¬ãƒƒãƒéƒ¨ä½ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
          ["neck", "shoulder", "chest", "back", "hip", "thigh", "calf"].forEach(
            (name) => {
              const checkbox = document.getElementById(name);
              if (checkbox) {
                checkbox.addEventListener("change", () => {
                  const parts = getStretchParts();
                  parts[name] = checkbox.checked;
                  setStretchParts(parts);
                  updateProgress();
                });
              }
            }
          );
        }

        // çŠ¶æ…‹ã‚’å¾©å…ƒ
        function restoreState() {
          const state = getState();

          // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
          const bikeDone = document.getElementById("bikeDone");
          const strengthDone = document.getElementById("strengthDone");
          const stretchDone = document.getElementById("stretchDone");

          if (bikeDone) bikeDone.checked = state.bikeDone || false;
          if (strengthDone) strengthDone.checked = state.strengthDone || false;
          if (stretchDone) stretchDone.checked = state.stretchDone || false;

          // ã‚»ãƒƒãƒˆæ•°ã‚’å¾©å…ƒ
          const sets = getSets();
          ["sq", "pu", "pl", "bd", "hl", "mc"].forEach((name) => {
            const input = document.getElementById(name);
            if (input) {
              input.value = sets[name] || 0;
            }
          });

          // ã‚¹ãƒˆãƒ¬ãƒƒãƒéƒ¨ä½ã‚’å¾©å…ƒ
          const parts = getStretchParts();
          ["neck", "shoulder", "chest", "back", "hip", "thigh", "calf"].forEach(
            (name) => {
              const checkbox = document.getElementById(name);
              if (checkbox) {
                checkbox.checked = parts[name] || false;
              }
            }
          );
        }

        // === Simple daily auto-save (one snapshot per date) ===
        var __autoSaveTimer = null; // varã«ã—ã¦TDZã‚’å›é¿
        function debounceSave(fn, delay = 800) {
          if (__autoSaveTimer) clearTimeout(__autoSaveTimer);
          __autoSaveTimer = setTimeout(fn, delay);
        }

        function upsertJournalByDate(entry) {
          const list = getJournal();
          const idx = list.findIndex((x) => x.dateKey === entry.dateKey);
          if (idx >= 0) list[idx] = entry;
          else list.push(entry);
          setJournal(list);
        }

        function saveTodaySnapshot(silent = false) {
          console.log("saveTodaySnapshot called, silent:", silent); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
          try {
            const e = summarizeToday();
            console.log("Snapshot data:", e); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
            e.date = new Date().toISOString(); // snapshot time
            upsertJournalByDate(e);
            renderLogTable();
            if (!silent) {
              alert("ä»Šæ—¥ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
            }
            console.log("Snapshot saved successfully"); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
          } catch (error) {
            console.error("Error saving snapshot:", error); // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
          }
        }

        function scheduleAutoSave() {
          debounceSave(() => {
            const e = summarizeToday();
            e.date = new Date().toISOString();
            upsertJournalByDate(e);
            renderLogTable();
            pushTodayToServer(e);
          }, 800);
        }

        // æ—¢å­˜ã®updateProgressã®æœ«å°¾ã§è‡ªå‹•ä¿å­˜ã‚’å‘¼ã¶

        function exportJson() {
          const data = getJournal();
          const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "bootcamp_journal_backup.json";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }

        function importJson(file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const parsed = JSON.parse(e.target.result);
              if (!Array.isArray(parsed)) throw new Error("Invalid format");
              setJournal(parsed);
              renderLogTable();
              alert("JSONã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
            } catch (err) {
              alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
            }
          };
          reader.readAsText(file, "utf-8");
        }

        // renderLogTable ã®é‡è¤‡ï¼ˆåŒã˜dateKeyãŒè¤‡æ•°ã‚ã‚‹å ´åˆï¼‰ã®æ•´ç†
        const _orig_render = renderLogTable;
        renderLogTable = function () {
          const tbody = document.querySelector("#logTable tbody");
          if (!tbody) return;
          tbody.innerHTML = "";
          // åŒã˜dateKeyã®ã†ã¡æœ€æ–°ã®dateã‚’æ¡ç”¨
          const map = new Map();
          getJournal().forEach((lg) => {
            const key = lg.dateKey || (lg.date || "").slice(0, 10);
            const cur = map.get(key);
            if (!cur || new Date(lg.date) > new Date(cur.date))
              map.set(key, { ...lg, dateKey: key });
          });
          const rows = Array.from(map.values()).sort((a, b) =>
            a.dateKey < b.dateKey ? 1 : -1
          ); // desc by dateKey

          rows.forEach((lg) => {
            const tr = document.createElement("tr");
            tr.style.borderBottom = "1px solid #223259";
            const dt = new Date(lg.date || lg.dateKey + "T00:00:00Z");
            const dtStr = dt.toLocaleString("ja-JP", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
            });
            tr.innerHTML = `
        <td style="padding:8px;">${dtStr}</td>
        <td style="padding:8px;">${lg.progress ?? "-"}</td>
        <td style="padding:8px;">${
          lg.bikeDone ? (lg.hiit ? "æœ‰é…¸ç´ +HIIT" : "æœ‰é…¸ç´ ") : "-"
        }</td>
        <td style="padding:8px;">${lg.sets?.sq ?? 0}</td>
        <td style="padding:8px;">${lg.sets?.pu ?? 0}</td>
        <td style="padding:8px;">${lg.sets?.pl ?? 0}</td>
        <td style="padding:8px;">${lg.sets?.bd ?? 0}</td>
        <td style="padding:8px;">${lg.sets?.hl ?? 0}</td>
        <td style="padding:8px;">${lg.sets?.mc ?? 0}</td>
        <td style="padding:8px;">${lg.stretchDone ? "âœ”" : "-"}</td>
        <td style="padding:8px; max-width:320px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${(
          lg.note || ""
        ).replace(/"/g, "&quot;")}">${lg.note || ""}</td>
        <td style="padding:8px;">
          <button class="btn ghost small" data-datekey="${
            lg.dateKey
          }">å‰Šé™¤</button>
        </td>
      `;
            tr.querySelector("button").addEventListener("click", (e) => {
              const key = e.target.dataset.datekey;
              const list = getJournal();
              const idx = list.findIndex((x) => (x.dateKey || "") === key);
              if (idx >= 0 && confirm("ã“ã®æ—¥ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                list.splice(idx, 1);
                setJournal(list);
                renderLogTable();
              }
            });
            tbody.appendChild(tr);
          });
        };
      })();
    </script>
  </body>
</html>
