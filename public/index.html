<!DOCTYPE html>

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width,initial-scale=1" name="viewport" />
    <!-- 非キャッシュ化（HTTPヘッダーが理想だが、HTML側からも明示） -->
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- 開発用: URLに ?dev=1 または ?nocache=1 を付けた時だけSWとCache Storageをクリアして最新HTMLを確実に取得する -->
    <script>
      // 開発時の更新反映補助（本番では ?dev / ?nocache を付けない限り実行されません）
      (function () {
        try {
          const qs = new URLSearchParams(location.search);
          if (qs.has("dev") || qs.has("nocache")) {
            // Service Worker を登録解除
            if ("serviceWorker" in navigator) {
              navigator.serviceWorker.getRegistrations().then((regs) => {
                regs.forEach((reg) => reg.unregister());
              });
            }
            // Cache Storage を全削除
            if (window.caches && caches.keys) {
              caches
                .keys()
                .then((keys) => keys.forEach((k) => caches.delete(k)));
            }
            // 直前のキャッシュを避けるため、初回は強制リロード
            if (!sessionStorage.getItem("nocacheReloaded")) {
              sessionStorage.setItem("nocacheReloaded", "1");
              // クエリは維持したままハードリロード相当の再読み込み
              location.reload();
            } else {
              sessionStorage.removeItem("nocacheReloaded");
            }
          }
        } catch (e) {
          // 失敗してもアプリ動作に影響を与えない
          console.warn("[CACHE-BUSTER] skipped:", e);
        }
      })();
    </script>
    <title>ブートキャンプ・スターター</title>
    <meta content="light dark" name="color-scheme" />
    <!-- Chart.js CDN (最新版) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
      :root {
        --bg: #0b1020;
        --card: #111931cc;
        --text: #eaf1ff;
        --muted: #b6c2e1;
        --accent: #6ee7ff;
        --ok: #6ee7a0;
        --warn: #ffd166;
        --danger: #ff6b6b;
        --ring: #2b3657;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        --radius: 18px;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto,
          "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic UI", "Meiryo",
          sans-serif;
        color: var(--text);
        background: radial-gradient(
            1200px 600px at 10% -10%,
            #132042 0%,
            transparent 60%
          ),
          radial-gradient(900px 500px at 110% 20%, #1f2e56 0%, transparent 60%),
          linear-gradient(160deg, #0a0f1c 0%, #0e1426 100%);
        background-attachment: fixed;
        padding-top: 20px; /* 通常の余白に戻す */
      }
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 24px 16px 80px;
      }

      /* スマホ対応の追加スタイル */
      @media (max-width: 768px) {
        body {
          padding-top: 20px; /* スマホでも通常の余白 */
        }

        .wrap {
          padding: 16px 12px 60px;
        }

        /* ボタンをタップしやすくする */
        .btn {
          min-height: 44px;
          font-size: 16px;
          padding: 12px 20px;
          touch-action: manipulation;
        }

        /* 入力フィールドの調整 */
        input[type="checkbox"] {
          transform: scale(1.3);
          margin-right: 8px;
        }

        /* エクササイズカードの調整 */
        .ex {
          grid-template-columns: 1fr;
          gap: 12px;
          padding: 16px;
        }

        .checkset {
          justify-content: center;
          gap: 12px;
        }

        .checkset label {
          min-width: 44px;
          min-height: 44px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 16px;
        }

        /* タイマー表示の調整 */
        #clock {
          font-size: 2em;
          text-align: center;
        }

        /* カードのグリッドを1列に */
        .grid {
          grid-template-columns: 1fr;
        }

        .card {
          grid-column: span 1;
        }
      }
      header {
        display: grid;
        gap: 14px;
        align-items: center;
        grid-template-columns: 1fr auto;
        margin-bottom: 18px;
      }
      .title {
        font-size: clamp(22px, 3vw, 32px);
        font-weight: 800;
        letter-spacing: 0.3px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .chipbar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .chip {
        background: linear-gradient(180deg, #1a2344, #131b34);
        border: 1px solid #26325a;
        color: #cfe3ff;
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 13px;
      }
      .grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(12, 1fr);
      }
      .card {
        grid-column: span 12;
        background: linear-gradient(180deg, #121a31, #0e162b);
        -webkit-backdrop-filter: blur(6px);
        backdrop-filter: blur(6px);
        border: 1px solid #243055;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 18px;
      }
      @media (min-width: 900px) {
        .span-7 {
          grid-column: span 7;
        }
        .span-5 {
          grid-column: span 5;
        }
      }
      h2 {
        margin: 0 0 8px;
        font-size: 18px;
      }
      .muted {
        color: var(--muted);
        font-size: 13px;
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .kpi {
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
        margin: 6px 0 12px;
      }
      .pill {
        background: #0b1226;
        border: 1px solid #243055;
        border-radius: 12px;
        padding: 8px 10px;
        font-size: 13px;
        color: #dbe6ff;
      }
      .progress {
        width: 100%;
        height: 12px;
        border-radius: 999px;
        background: #0b1328;
        border: 1px solid #233055;
        overflow: hidden;
      }
      .progress > span {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, #33d1ff, #7af0ff);
        width: 0%;
      }
      .btn {
        border: none;
        border-radius: 12px;
        padding: 10px 14px;
        font-weight: 700;
        cursor: pointer;
        background: linear-gradient(180deg, #27b8ff, #1aa3e6);
        color: #042032;
        box-shadow: 0 6px 18px rgba(39, 184, 255, 0.35);
      }
      .btn.secondary {
        background: linear-gradient(180deg, #2a3357, #1a2242);
        color: #d7e6ff;
        border: 1px solid #2e3a66;
        box-shadow: none;
      }
      .btn.ghost {
        background: transparent;
        border: 1px dashed #2a3968;
        color: #bcd5ff;
      }
      .tag {
        font-size: 12px;
        background: #112044;
        border: 1px solid #26325a;
        padding: 4px 8px;
        border-radius: 999px;
        color: #bfe8ff;
      }
      .list {
        display: grid;
        gap: 10px;
        margin-top: 10px;
      }
      .ex {
        display: grid;
        gap: 10px;
        grid-template-columns: 1fr auto;
        align-items: center;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid #223259;
        background: linear-gradient(180deg, #0f1831, #0c1429);
      }
      .ex .meta {
        font-size: 14px;
      }
      .ex .meta b {
        font-size: 15px;
      }
      .ex .steps {
        font-size: 12px;
        color: #c6d6ff;
      }
      .checkset {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .checkset input {
        accent-color: #33d1ff;
        width: 18px;
        height: 18px;
      }
      .timer {
        display: grid;
        gap: 10px;
        grid-template-columns: 1fr auto;
        align-items: center;
        margin: 12px 0 4px;
      }
      .clock {
        font-variant-numeric: tabular-nums;
        font-size: 28px;
        font-weight: 800;
        letter-spacing: 0.5px;
      }
      .seglist {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .seg {
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid #2a3968;
        background: #0f1937;
        font-size: 12px;
        color: #bfe8ff;
      }
      .note {
        font-size: 12px;
        color: #bcd2ff;
        margin-top: 8px;
      }
      footer {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        gap: 10px;
        justify-content: center;
        align-items: center;
        padding: 10px;
        background: linear-gradient(
          180deg,
          transparent,
          rgba(10, 15, 28, 0.85)
        );
        -webkit-backdrop-filter: blur(6px);
        backdrop-filter: blur(6px);
      }
      .quote {
        font-style: italic;
        color: #cfe3ff;
      }
      .switch {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .switch input {
        width: 42px;
        height: 22px;
      }
      .small {
        font-size: 12px;
      }
      .log-table-wrap {
        overflow-x: auto;
        width: 100%;
        border-radius: 12px;
        border: 1px solid #223259;
        background: #0f1831;
      }
      #logTable {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        min-width: 700px;
      }
      #logTable th,
      #logTable td {
        min-width: 70px;
        padding: 6px 4px;
        word-break: break-word;
        text-align: left;
      }
      @media (max-width: 600px) {
        #logTable {
          font-size: 11px;
          min-width: 480px;
        }
        #logTable th,
        #logTable td {
          min-width: 48px;
          padding: 4px 2px;
        }
        .log-table-wrap {
          border-radius: 8px;
        }
      }
    </style>
    <script>
      // === Utilities ===
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));
      const todayStr = new Date().toLocaleDateString("ja-JP", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
      });
      const keyBase = () => new Date().toISOString().slice(0, 10); // YYYY-MM-DD
      const LSKEY = (suffix) => `bootcamp.${suffix}`;

      // グローバル変数
      let autoSaveTimer = null;

      // === グローバル関数定義 ===
      // これらの関数をグローバルスコープで定義してIIFE内の重複定義を回避

      function collectSets() {
        // 各セットのチェック状態（または数値入力があれば数値）を収集
        const sets = {};
        console.log("[DEBUG] collectSets開始");
        $$(".set").forEach((ch) => {
          const key = ch.dataset.key;
          console.log(
            `[DEBUG] セット処理中: key=${key}, checked=${ch.checked}`
          );

          // 将来、数値入力が追加された場合はそちらを優先し、なければチェック状態(1/0)
          const numInput = document.getElementById(`${key}Count`);
          if (numInput) {
            // 数値入力が存在する場合は数値を採用
            sets[key] = parseInt(numInput.value || "0", 10);
            console.log(`[DEBUG] 数値入力使用: ${key} = ${sets[key]}`);
          } else {
            // 数値入力が無い現在のUIではチェック済み=1、未チェック=0
            sets[key] = ch.checked ? 1 : 0;
            console.log(`[DEBUG] チェックボックス使用: ${key} = ${sets[key]}`);
          }
        });
        console.log("[DEBUG] collectSets結果:", sets);
        return sets;
      }

      function collectStretch() {
        const parts = {};
        console.log("[DEBUG] collectStretch開始");
        $$(".str").forEach((ch) => {
          const key = ch.dataset.key;
          parts[key] = ch.checked;
          console.log(
            `[DEBUG] ストレッチ処理中: key=${key}, checked=${ch.checked}`
          );
        });
        console.log("[DEBUG] collectStretch結果:", parts);
        return parts;
      }

      function updateProgress() {
        // バー要素とテキスト要素を取得
        const progressBar = document.getElementById("progressBar");
        if (!progressBar) return;

        // DOMの現状から直接進捗を算出（サーバー応答に依存しない）
        // 注意: strengthDoneとstretchDoneは進捗計算に含めず、小項目のみで計算
        const s = {
          bikeDone: document.getElementById("bikeDone")?.checked || false,
        };
        const sets = collectSets();
        const stretchParts = collectStretch();

        // 筋トレ：全セットが完了しているかチェック
        const strengthSets = [
          "sq-1",
          "sq-2",
          "pu-1",
          "pu-2",
          "pl-1",
          "pl-2",
          "pl-3",
          "bd-1",
          "bd-2",
          "mc-1",
          "mc-2",
        ];
        const completedStrengthSets = strengthSets.filter(
          (setKey) => sets[setKey] > 0
        ).length;
        const strengthCompleted = completedStrengthSets === strengthSets.length;

        // ストレッチ：全部位が完了しているかチェック
        const stretchKeys = Object.keys(stretchParts);
        const completedStretchParts = stretchKeys.filter(
          (key) => stretchParts[key]
        ).length;
        const stretchCompleted =
          stretchKeys.length > 0 &&
          completedStretchParts === stretchKeys.length;

        // 全項目が完了した場合は100%にする（小項目ベース）
        const allItemsCompleted =
          s.bikeDone && strengthCompleted && stretchCompleted;

        if (allItemsCompleted) {
          const totalProgress = 100;
          progressBar.style.width = `${totalProgress}%`;
          progressBar.textContent = `${totalProgress}%`;
          console.log(`[DEBUG] 全小項目完了により進捗100%に設定`);
          // 進捗表示の更新（ヘッダーの #progressText に反映）
          const progressTextEl = document.getElementById("progressText");
          if (progressTextEl) {
            progressTextEl.textContent = `${totalProgress}%`;
          }
          return;
        }

        // 3つの主要カテゴリーの完了率を計算（各々33.3%の重み）
        const bikeProgress = s.bikeDone ? 1 : 0;
        const strengthProgress =
          strengthSets.length > 0
            ? completedStrengthSets / strengthSets.length
            : 0;
        const stretchProgress =
          stretchKeys.length > 0
            ? completedStretchParts / stretchKeys.length
            : 0;

        const totalProgress = Math.round(
          (100 * (bikeProgress + strengthProgress + stretchProgress)) / 3
        );
        progressBar.style.width = `${totalProgress}%`;

        // 進捗表示の更新（ヘッダーの #progressText に反映）
        const progressTextEl = document.getElementById("progressText");
        if (progressTextEl) {
          progressTextEl.textContent = `${totalProgress}%`;
        }
      }

      function initializeToday() {
        // 日付を表示
        const todayEl = document.querySelector("#today");
        if (todayEl) {
          todayEl.textContent = todayStr;
        }

        // 挨拶を設定
        const hour = new Date().getHours();
        const greetEl = $("#greet");
        if (greetEl) {
          greetEl.textContent =
            hour < 5
              ? "早朝セッション"
              : hour < 12
              ? "おはようございます"
              : hour < 18
              ? "こんにちは"
              : "こんばんは";
        }

        // 進捗バーやチェックボックスなどを初期状態に戻す
        collectSets();
        collectStretch();
        updateProgress();
        // メモ欄も空に
        const noteEl = document.querySelector("#note");
        if (noteEl) noteEl.value = "";
      }

      function testProgressBar() {
        updateProgress();
      }
      // === データベース中心のデータ管理 ===
      // ローカルストレージの代わりにサーバーAPIを使用

      // 現在の状態を取得（サーバーから）
      async function getState() {
        try {
          const ok = await ensureLogin();
          if (!ok) return {};

          const dateKey = keyBase();
          const res = await fetch(`/api/logs/${dateKey}`);
          if (!res.ok) {
            if (res.status === 404) {
              return {}; // 今日のデータがまだない場合
            }
            throw new Error(`Server error: ${res.status}`);
          }

          const data = await res.json();
          return data || {};
        } catch (e) {
          console.warn("Failed to get state from server:", e);
          return {};
        }
      }

      // 状態を保存（サーバーに）
      async function setState(state) {
        try {
          const ok = await ensureLogin();
          if (!ok) return;

          const entry = {
            ...state,
            date: new Date().toISOString(),
            dateKey: keyBase(),
          };

          await pushTodayToServer(entry);
        } catch (e) {
          console.warn("Failed to set state to server:", e);
        }
      }

      // セット数の取得
      async function getSets() {
        const state = await getState();
        return state.sets || {};
      }

      // ストレッチ部位の取得
      async function getStretchParts() {
        const state = await getState();
        return state.stretchParts || {};
      }

      // ログ一覧の取得（完全にサーバーから）
      async function getJournal() {
        try {
          const ok = await ensureLogin();
          if (!ok) return [];

          const res = await fetch("/api/logs");
          if (!res.ok) throw new Error(`Server error: ${res.status}`);
          const logs = await res.json();
          return Array.isArray(logs) ? logs : [];
        } catch (e) {
          console.warn("Failed to get journal from server:", e);
          return [];
        }
      }

      // ログ一覧の設定（不要になったが互換性のため残す）
      function setJournal(logs) {
        // この関数は互換性のためのダミー
        console.log("setJournal called (deprecated, using server directly)");
      }

      // チェック状態の更新
      async function mark(key, checked) {
        const state = await getState();
        state[key] = checked;
        await setState(state);
        updateProgress();
        scheduleAutoSave();
      }

      // セットアップイベントリスナー
      function setupEventListeners() {
        // 保存ボタン
        const saveBtn = document.getElementById("saveLog");
        if (saveBtn)
          saveBtn.addEventListener("click", () => {
            saveTodaySnapshot(false);
          });

        // CSVエクスポートボタン
        const exportCsvBtn = document.getElementById("exportCsv");
        if (exportCsvBtn) {
          exportCsvBtn.addEventListener("click", async () => {
            try {
              const ok = await ensureLogin();
              if (ok) {
                window.open("/api/logs/export", "_blank");
              }
            } catch (e) {
              console.warn("CSV export failed:", e);
            }
          });
        }

        // すべての記録を削除ボタン
        const clearAllBtn = document.getElementById("clearAllLogs");
        if (clearAllBtn) {
          clearAllBtn.addEventListener("click", async () => {
            if (
              confirm("すべての記録を削除しますか？この操作は取り消せません。")
            ) {
              try {
                // サーバーから全ログを取得して削除
                const logs = await getJournal();
                for (const log of logs) {
                  if (log.dateKey) {
                    await fetch(`/api/logs/${log.dateKey}`, {
                      method: "DELETE",
                    });
                  }
                }
                await renderLogTable();
                alert("すべての記録を削除しました。");
              } catch (e) {
                console.warn("Clear all logs failed:", e);
              }
            }
          });
        }

        // 今日の記録を削除ボタン
        const deleteTodayBtn = document.getElementById("deleteTodayLog");
        if (deleteTodayBtn) {
          deleteTodayBtn.addEventListener("click", async () => {
            const today = new Date().toISOString().split("T")[0];
            if (
              confirm(
                `今日（${today}）の記録を削除しますか？この操作は取り消せません。`
              )
            ) {
              try {
                // 今日のワークアウト記録を削除
                const response = await fetch(`/api/logs/${today}`, {
                  method: "DELETE",
                });

                if (response.ok) {
                  await renderLogTable();
                  // チェックボックス状態もリセット
                  document
                    .querySelectorAll('input[type="checkbox"]')
                    .forEach((cb) => {
                      cb.checked = false;
                    });
                  updateProgress();
                  alert("今日の記録を削除しました。");
                } else {
                  alert("削除に失敗しました。");
                }
              } catch (e) {
                console.warn("Delete today log failed:", e);
                alert("削除処理中にエラーが発生しました。");
              }
            }
          });
        }

        // JSONバックアップボタン
        const exportJsonBtn = document.getElementById("exportJson");
        if (exportJsonBtn) {
          exportJsonBtn.addEventListener("click", async () => {
            const logs = await getJournal();
            const blob = new Blob([JSON.stringify(logs, null, 2)], {
              type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `workout-logs-${new Date()
              .toISOString()
              .slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          });
        }
      }

      // 状態復元
      async function restoreState() {
        const state = await getState();

        // チェックボックスの状態を復元
        $$(".set").forEach(async (ch) => {
          const key = `set.${ch.dataset.key}`;
          ch.checked = !!state[key];
        });

        $$(".str").forEach(async (ch) => {
          const key = `str.${ch.dataset.key}`;
          ch.checked = !!state[key];
        });

        // メイン完了チェックボックスの状態を復元
        const strengthDoneEl = $("#strengthDone");
        const stretchDoneEl = $("#stretchDone");
        const bikeDoneEl = $("#bikeDone");

        if (strengthDoneEl) strengthDoneEl.checked = !!state.strengthDone;
        if (stretchDoneEl) stretchDoneEl.checked = !!state.stretchDone;
        if (bikeDoneEl) bikeDoneEl.checked = !!state.bikeDone;

        // 追加: 再読み込み時でも「全メニュー完了」の状態を個別項目に反映
        if (state.strengthDone) {
          const strengthSets = [
            "sq-1",
            "sq-2",
            "pu-1",
            "pu-2",
            "pl-1",
            "pl-2",
            "pl-3",
            "bd-1",
            "bd-2",
            "mc-1",
            "mc-2",
          ];
          strengthSets.forEach((setKey) => {
            const el = document.querySelector(`.set[data-key="${setKey}"]`);
            if (el) el.checked = true; // UIに確実に反映（イベント送出は不要）
          });
        }
        if (state.stretchDone) {
          const stretchParts = [
            "st-thigh",
            "st-calf",
            "st-shoulder",
            "st-chest",
          ];
          stretchParts.forEach((partKey) => {
            const el = document.querySelector(`.str[data-key="${partKey}"]`);
            if (el) el.checked = true;
          });
        }

        // セット数の復元
        if (state.sets) {
          Object.entries(state.sets).forEach(([key, value]) => {
            const input = $(`#${key}Count`);
            if (input) input.value = value || 0;
          });
        }

        // メモの復元
        const noteEl = $("#note");
        if (noteEl && state.note) {
          noteEl.value = state.note;
        }

        updateProgress();
      }
      // --- ログイン状態の確認（リダイレクト対応） ---
      async function ensureLogin() {
        const me = await fetch("/api/