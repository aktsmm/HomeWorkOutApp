<!DOCTYPE html>

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width,initial-scale=1" name="viewport" />
    <!-- éã‚­ãƒ£ãƒƒã‚·ãƒ¥åŒ–ï¼ˆHTTPãƒ˜ãƒƒãƒ€ãƒ¼ãŒç†æƒ³ã ãŒã€HTMLå´ã‹ã‚‰ã‚‚æ˜ç¤ºï¼‰ -->
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- é–‹ç™ºç”¨: URLã« ?dev=1 ã¾ãŸã¯ ?nocache=1 ã‚’ä»˜ã‘ãŸæ™‚ã ã‘SWã¨Cache Storageã‚’ã‚¯ãƒªã‚¢ã—ã¦æœ€æ–°HTMLã‚’ç¢ºå®Ÿã«å–å¾—ã™ã‚‹ -->
    <script>
      // é–‹ç™ºæ™‚ã®æ›´æ–°åæ˜ è£œåŠ©ï¼ˆæœ¬ç•ªã§ã¯ ?dev / ?nocache ã‚’ä»˜ã‘ãªã„é™ã‚Šå®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ï¼‰
      (function () {
        try {
          const qs = new URLSearchParams(location.search);
          if (qs.has("dev") || qs.has("nocache")) {
            // Service Worker ã‚’ç™»éŒ²è§£é™¤
            if ("serviceWorker" in navigator) {
              navigator.serviceWorker.getRegistrations().then((regs) => {
                regs.forEach((reg) => reg.unregister());
              });
            }
            // Cache Storage ã‚’å…¨å‰Šé™¤
            if (window.caches && caches.keys) {
              caches
                .keys()
                .then((keys) => keys.forEach((k) => caches.delete(k)));
            }
            // ç›´å‰ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’é¿ã‘ã‚‹ãŸã‚ã€åˆå›ã¯å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰
            if (!sessionStorage.getItem("nocacheReloaded")) {
              sessionStorage.setItem("nocacheReloaded", "1");
              // ã‚¯ã‚¨ãƒªã¯ç¶­æŒã—ãŸã¾ã¾ãƒãƒ¼ãƒ‰ãƒªãƒ­ãƒ¼ãƒ‰ç›¸å½“ã®å†èª­ã¿è¾¼ã¿
              location.reload();
            } else {
              sessionStorage.removeItem("nocacheReloaded");
            }
          }
        } catch (e) {
          // å¤±æ•—ã—ã¦ã‚‚ã‚¢ãƒ—ãƒªå‹•ä½œã«å½±éŸ¿ã‚’ä¸ãˆãªã„
          console.warn("[CACHE-BUSTER] skipped:", e);
        }
      })();
    </script>
    <title>ãƒ–ãƒ¼ãƒˆã‚­ãƒ£ãƒ³ãƒ—ãƒ»ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼</title>
    <meta content="light dark" name="color-scheme" />
    <!-- Chart.js CDN (æœ€æ–°ç‰ˆ) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
      :root {
        --bg: #0b1020;
        --card: #111931cc;
        --text: #eaf1ff;
        --muted: #b6c2e1;
        --accent: #6ee7ff;
        --ok: #6ee7a0;
        --warn: #ffd166;
        --danger: #ff6b6b;
        --ring: #2b3657;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        --radius: 18px;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto,
          "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic UI", "Meiryo",
          sans-serif;
        color: var(--text);
        background: radial-gradient(
            1200px 600px at 10% -10%,
            #132042 0%,
            transparent 60%
          ),
          radial-gradient(900px 500px at 110% 20%, #1f2e56 0%, transparent 60%),
          linear-gradient(160deg, #0a0f1c 0%, #0e1426 100%);
        background-attachment: fixed;
        padding-top: 20px; /* é€šå¸¸ã®ä½™ç™½ã«æˆ»ã™ */
      }
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 24px 16px 80px;
      }

      /* ã‚¹ãƒãƒ›å¯¾å¿œã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
      @media (max-width: 768px) {
        body {
          padding-top: 20px; /* ã‚¹ãƒãƒ›ã§ã‚‚é€šå¸¸ã®ä½™ç™½ */
        }

        .wrap {
          padding: 16px 12px 60px;
        }

        /* ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã‚„ã™ãã™ã‚‹ */
        .btn {
          min-height: 44px;
          font-size: 16px;
          padding: 12px 20px;
          touch-action: manipulation;
        }

        /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®èª¿æ•´ */
        input[type="checkbox"] {
          transform: scale(1.3);
          margin-right: 8px;
        }

        /* ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºã‚«ãƒ¼ãƒ‰ã®èª¿æ•´ */
        .ex {
          grid-template-columns: 1fr;
          gap: 12px;
          padding: 16px;
        }

        .checkset {
          justify-content: center;
          gap: 12px;
        }

        .checkset label {
          min-width: 44px;
          min-height: 44px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 16px;
        }

        /* ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã®èª¿æ•´ */
        #clock {
          font-size: 2em;
          text-align: center;
        }

        /* ã‚«ãƒ¼ãƒ‰ã®ã‚°ãƒªãƒƒãƒ‰ã‚’1åˆ—ã« */
        .grid {
          grid-template-columns: 1fr;
        }

        .card {
          grid-column: span 1;
        }
      }
      header {
        display: grid;
        gap: 14px;
        align-items: center;
        grid-template-columns: 1fr auto;
        margin-bottom: 18px;
      }
      .title {
        font-size: clamp(22px, 3vw, 32px);
        font-weight: 800;
        letter-spacing: 0.3px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .chipbar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .chip {
        background: linear-gradient(180deg, #1a2344, #131b34);
        border: 1px solid #26325a;
        color: #cfe3ff;
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 13px;
      }
      .grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(12, 1fr);
      }
      .card {
        grid-column: span 12;
        background: linear-gradient(180deg, #121a31, #0e162b);
        -webkit-backdrop-filter: blur(6px);
        backdrop-filter: blur(6px);
        border: 1px solid #243055;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 18px;
      }
      @media (min-width: 900px) {
        .span-7 {
          grid-column: span 7;
        }
        .span-5 {
          grid-column: span 5;
        }
      }
      h2 {
        margin: 0 0 8px;
        font-size: 18px;
      }
      .muted {
        color: var(--muted);
        font-size: 13px;
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .kpi {
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
        margin: 6px 0 12px;
      }
      .pill {
        background: #0b1226;
        border: 1px solid #243055;
        border-radius: 12px;
        padding: 8px 10px;
        font-size: 13px;
        color: #dbe6ff;
      }
      .progress {
        width: 100%;
        height: 12px;
        border-radius: 999px;
        background: #0b1328;
        border: 1px solid #233055;
        overflow: hidden;
      }
      .progress > span {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, #33d1ff, #7af0ff);
        width: 0%;
      }
      .btn {
        border: none;
        border-radius: 12px;
        padding: 10px 14px;
        font-weight: 700;
        cursor: pointer;
        background: linear-gradient(180deg, #27b8ff, #1aa3e6);
        color: #042032;
        box-shadow: 0 6px 18px rgba(39, 184, 255, 0.35);
      }
      .btn.secondary {
        background: linear-gradient(180deg, #2a3357, #1a2242);
        color: #d7e6ff;
        border: 1px solid #2e3a66;
        box-shadow: none;
      }
      .btn.ghost {
        background: transparent;
        border: 1px dashed #2a3968;
        color: #bcd5ff;
      }
      .tag {
        font-size: 12px;
        background: #112044;
        border: 1px solid #26325a;
        padding: 4px 8px;
        border-radius: 999px;
        color: #bfe8ff;
      }
      .list {
        display: grid;
        gap: 10px;
        margin-top: 10px;
      }
      .ex {
        display: grid;
        gap: 10px;
        grid-template-columns: 1fr auto;
        align-items: center;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid #223259;
        background: linear-gradient(180deg, #0f1831, #0c1429);
      }
      .ex .meta {
        font-size: 14px;
      }
      .ex .meta b {
        font-size: 15px;
      }
      .ex .steps {
        font-size: 12px;
        color: #c6d6ff;
      }
      .checkset {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .checkset input {
        accent-color: #33d1ff;
        width: 18px;
        height: 18px;
      }
      .timer {
        display: grid;
        gap: 10px;
        grid-template-columns: 1fr auto;
        align-items: center;
        margin: 12px 0 4px;
      }
      .clock {
        font-variant-numeric: tabular-nums;
        font-size: 28px;
        font-weight: 800;
        letter-spacing: 0.5px;
      }
      .seglist {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .seg {
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid #2a3968;
        background: #0f1937;
        font-size: 12px;
        color: #bfe8ff;
      }
      .note {
        font-size: 12px;
        color: #bcd2ff;
        margin-top: 8px;
      }
      footer {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        gap: 10px;
        justify-content: center;
        align-items: center;
        padding: 10px;
        background: linear-gradient(
          180deg,
          transparent,
          rgba(10, 15, 28, 0.85)
        );
        -webkit-backdrop-filter: blur(6px);
        backdrop-filter: blur(6px);
      }
      .quote {
        font-style: italic;
        color: #cfe3ff;
      }
      .switch {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .switch input {
        width: 42px;
        height: 22px;
      }
      .small {
        font-size: 12px;
      }
      .log-table-wrap {
        overflow-x: auto;
        width: 100%;
        border-radius: 12px;
        border: 1px solid #223259;
        background: #0f1831;
      }
      #logTable {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        min-width: 700px;
      }
      #logTable th,
      #logTable td {
        min-width: 70px;
        padding: 6px 4px;
        word-break: break-word;
        text-align: left;
      }
      @media (max-width: 600px) {
        #logTable {
          font-size: 11px;
          min-width: 480px;
        }
        #logTable th,
        #logTable td {
          min-width: 48px;
          padding: 4px 2px;
        }
        .log-table-wrap {
          border-radius: 8px;
        }
      }
    </style>
    <script>
      // === Utilities ===
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));
      const todayStr = new Date().toLocaleDateString("ja-JP", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
      });
      const keyBase = () => new Date().toISOString().slice(0, 10); // YYYY-MM-DD
      const LSKEY = (suffix) => `bootcamp.${suffix}`;

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
      let autoSaveTimer = null;

      // === ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°å®šç¾© ===
      // ã“ã‚Œã‚‰ã®é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å®šç¾©ã—ã¦IIFEå†…ã®é‡è¤‡å®šç¾©ã‚’å›é¿

      function collectSets() {
        // å„ã‚»ãƒƒãƒˆã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ï¼ˆã¾ãŸã¯æ•°å€¤å…¥åŠ›ãŒã‚ã‚Œã°æ•°å€¤ï¼‰ã‚’åé›†
        const sets = {};
        console.log("[DEBUG] collectSetsé–‹å§‹");
        $$(".set").forEach((ch) => {
          const key = ch.dataset.key;
          console.log(
            `[DEBUG] ã‚»ãƒƒãƒˆå‡¦ç†ä¸­: key=${key}, checked=${ch.checked}`
          );

          // å°†æ¥ã€æ•°å€¤å…¥åŠ›ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã¯ãã¡ã‚‰ã‚’å„ªå…ˆã—ã€ãªã‘ã‚Œã°ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹(1/0)
          const numInput = document.getElementById(`${key}Count`);
          if (numInput) {
            // æ•°å€¤å…¥åŠ›ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯æ•°å€¤ã‚’æ¡ç”¨
            sets[key] = parseInt(numInput.value || "0", 10);
            console.log(`[DEBUG] æ•°å€¤å…¥åŠ›ä½¿ç”¨: ${key} = ${sets[key]}`);
          } else {
            // æ•°å€¤å…¥åŠ›ãŒç„¡ã„ç¾åœ¨ã®UIã§ã¯ãƒã‚§ãƒƒã‚¯æ¸ˆã¿=1ã€æœªãƒã‚§ãƒƒã‚¯=0
            sets[key] = ch.checked ? 1 : 0;
            console.log(`[DEBUG] ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä½¿ç”¨: ${key} = ${sets[key]}`);
          }
        });
        console.log("[DEBUG] collectSetsçµæœ:", sets);
        return sets;
      }

      function collectStretch() {
        const parts = {};
        console.log("[DEBUG] collectStretché–‹å§‹");
        $$(".str").forEach((ch) => {
          const key = ch.dataset.key;
          parts[key] = ch.checked;
          console.log(
            `[DEBUG] ã‚¹ãƒˆãƒ¬ãƒƒãƒå‡¦ç†ä¸­: key=${key}, checked=${ch.checked}`
          );
        });
        console.log("[DEBUG] collectStretchçµæœ:", parts);
        return parts;
      }

      function updateProgress() {
        // ãƒãƒ¼è¦ç´ ã¨ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã‚’å–å¾—
        const progressBar = document.getElementById("progressBar");
        if (!progressBar) return;

        // DOMã®ç¾çŠ¶ã‹ã‚‰ç›´æ¥é€²æ—ã‚’ç®—å‡ºï¼ˆã‚µãƒ¼ãƒãƒ¼å¿œç­”ã«ä¾å­˜ã—ãªã„ï¼‰
        // æ³¨æ„: strengthDoneã¨stretchDoneã¯é€²æ—è¨ˆç®—ã«å«ã‚ãšã€å°é …ç›®ã®ã¿ã§è¨ˆç®—
        const s = {
          bikeDone: document.getElementById("bikeDone")?.checked || false,
        };
        const sets = collectSets();
        const stretchParts = collectStretch();

        // ç­‹ãƒˆãƒ¬ï¼šå…¨ã‚»ãƒƒãƒˆãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const strengthSets = [
          "sq-1",
          "sq-2",
          "pu-1",
          "pu-2",
          "pl-1",
          "pl-2",
          "pl-3",
          "bd-1",
          "bd-2",
          "mc-1",
          "mc-2",
        ];
        const completedStrengthSets = strengthSets.filter(
          (setKey) => sets[setKey] > 0
        ).length;
        const strengthCompleted = completedStrengthSets === strengthSets.length;

        // ã‚¹ãƒˆãƒ¬ãƒƒãƒï¼šå…¨éƒ¨ä½ãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const stretchKeys = Object.keys(stretchParts);
        const completedStretchParts = stretchKeys.filter(
          (key) => stretchParts[key]
        ).length;
        const stretchCompleted =
          stretchKeys.length > 0 &&
          completedStretchParts === stretchKeys.length;

        // å…¨é …ç›®ãŒå®Œäº†ã—ãŸå ´åˆã¯100%ã«ã™ã‚‹ï¼ˆå°é …ç›®ãƒ™ãƒ¼ã‚¹ï¼‰
        const allItemsCompleted =
          s.bikeDone && strengthCompleted && stretchCompleted;

        if (allItemsCompleted) {
          const totalProgress = 100;
          progressBar.style.width = `${totalProgress}%`;
          progressBar.textContent = `${totalProgress}%`;
          console.log(`[DEBUG] å…¨å°é …ç›®å®Œäº†ã«ã‚ˆã‚Šé€²æ—100%ã«è¨­å®š`);
          // é€²æ—è¡¨ç¤ºã®æ›´æ–°ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã® #progressText ã«åæ˜ ï¼‰
          const progressTextEl = document.getElementById("progressText");
          if (progressTextEl) {
            progressTextEl.textContent = `${totalProgress}%`;
          }
          return;
        }

        // 3ã¤ã®ä¸»è¦ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®å®Œäº†ç‡ã‚’è¨ˆç®—ï¼ˆå„ã€…33.3%ã®é‡ã¿ï¼‰
        const bikeProgress = s.bikeDone ? 1 : 0;
        const strengthProgress =
          strengthSets.length > 0
            ? completedStrengthSets / strengthSets.length
            : 0;
        const stretchProgress =
          stretchKeys.length > 0
            ? completedStretchParts / stretchKeys.length
            : 0;

        const totalProgress = Math.round(
          (100 * (bikeProgress + strengthProgress + stretchProgress)) / 3
        );
        progressBar.style.width = `${totalProgress}%`;

        // é€²æ—è¡¨ç¤ºã®æ›´æ–°ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã® #progressText ã«åæ˜ ï¼‰
        const progressTextEl = document.getElementById("progressText");
        if (progressTextEl) {
          progressTextEl.textContent = `${totalProgress}%`;
        }
      }

      function initializeToday() {
        // æ—¥ä»˜ã‚’è¡¨ç¤º
        const todayEl = document.querySelector("#today");
        if (todayEl) {
          todayEl.textContent = todayStr;
        }

        // æŒ¨æ‹¶ã‚’è¨­å®š
        const hour = new Date().getHours();
        const greetEl = $("#greet");
        if (greetEl) {
          greetEl.textContent =
            hour < 5
              ? "æ—©æœã‚»ãƒƒã‚·ãƒ§ãƒ³"
              : hour < 12
              ? "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™"
              : hour < 18
              ? "ã“ã‚“ã«ã¡ã¯"
              : "ã“ã‚“ã°ã‚“ã¯";
        }

        // é€²æ—ãƒãƒ¼ã‚„ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãªã©ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
        collectSets();
        collectStretch();
        updateProgress();
        // ãƒ¡ãƒ¢æ¬„ã‚‚ç©ºã«
        const noteEl = document.querySelector("#note");
        if (noteEl) noteEl.value = "";
      }

      function testProgressBar() {
        updateProgress();
      }
      // === ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸­å¿ƒã®ãƒ‡ãƒ¼ã‚¿ç®¡ç† ===
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ä»£ã‚ã‚Šã«ã‚µãƒ¼ãƒãƒ¼APIã‚’ä½¿ç”¨

      // ç¾åœ¨ã®çŠ¶æ…‹ã‚’å–å¾—ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ï¼‰
      async function getState() {
        try {
          const ok = await ensureLogin();
          if (!ok) return {};

          const dateKey = keyBase();
          const res = await fetch(`/api/logs/${dateKey}`);
          if (!res.ok) {
            if (res.status === 404) {
              return {}; // ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ãªã„å ´åˆ
            }
            throw new Error(`Server error: ${res.status}`);
          }

          const data = await res.json();
          return data || {};
        } catch (e) {
          console.warn("Failed to get state from server:", e);
          return {};
        }
      }

      // çŠ¶æ…‹ã‚’ä¿å­˜ï¼ˆã‚µãƒ¼ãƒãƒ¼ã«ï¼‰
      async function setState(state) {
        try {
          const ok = await ensureLogin();
          if (!ok) return;

          const entry = {
            ...state,
            date: new Date().toISOString(),
            dateKey: keyBase(),
          };

          await pushTodayToServer(entry);
        } catch (e) {
          console.warn("Failed to set state to server:", e);
        }
      }

      // ã‚»ãƒƒãƒˆæ•°ã®å–å¾—
      async function getSets() {
        const state = await getState();
        return state.sets || {};
      }

      // ã‚¹ãƒˆãƒ¬ãƒƒãƒéƒ¨ä½ã®å–å¾—
      async function getStretchParts() {
        const state = await getState();
        return state.stretchParts || {};
      }

      // ãƒ­ã‚°ä¸€è¦§ã®å–å¾—ï¼ˆå®Œå…¨ã«ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ï¼‰
      async function getJournal() {
        try {
          const ok = await ensureLogin();
          if (!ok) return [];

          const res = await fetch("/api/logs");
          if (!res.ok) throw new Error(`Server error: ${res.status}`);
          const logs = await res.json();
          return Array.isArray(logs) ? logs : [];
        } catch (e) {
          console.warn("Failed to get journal from server:", e);
          return [];
        }
      }

      // ãƒ­ã‚°ä¸€è¦§ã®è¨­å®šï¼ˆä¸è¦ã«ãªã£ãŸãŒäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
      function setJournal(logs) {
        // ã“ã®é–¢æ•°ã¯äº’æ›æ€§ã®ãŸã‚ã®ãƒ€ãƒŸãƒ¼
        console.log("setJournal called (deprecated, using server directly)");
      }

      // ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã®æ›´æ–°
      async function mark(key, checked) {
        const state = await getState();
        state[key] = checked;
        await setState(state);
        updateProgress();
        scheduleAutoSave();
      }

      // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      function setupEventListeners() {
        // ä¿å­˜ãƒœã‚¿ãƒ³
        const saveBtn = document.getElementById("saveLog");
        if (saveBtn)
          saveBtn.addEventListener("click", () => {
            saveTodaySnapshot(false);
          });

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³
        const exportCsvBtn = document.getElementById("exportCsv");
        if (exportCsvBtn) {
          exportCsvBtn.addEventListener("click", async () => {
            try {
              const ok = await ensureLogin();
              if (ok) {
                window.open("/api/logs/export", "_blank");
              }
            } catch (e) {
              console.warn("CSV export failed:", e);
            }
          });
        }

        // ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ãƒœã‚¿ãƒ³
        const clearAllBtn = document.getElementById("clearAllLogs");
        if (clearAllBtn) {
          clearAllBtn.addEventListener("click", async () => {
            if (
              confirm("ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")
            ) {
              try {
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å…¨ãƒ­ã‚°ã‚’å–å¾—ã—ã¦å‰Šé™¤
                const logs = await getJournal();
                for (const log of logs) {
                  if (log.dateKey) {
                    await fetch(`/api/logs/${log.dateKey}`, {
                      method: "DELETE",
                    });
                  }
                }
                await renderLogTable();
                alert("ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
              } catch (e) {
                console.warn("Clear all logs failed:", e);
              }
            }
          });
        }

        // ä»Šæ—¥ã®è¨˜éŒ²ã‚’å‰Šé™¤ãƒœã‚¿ãƒ³
        const deleteTodayBtn = document.getElementById("deleteTodayLog");
        if (deleteTodayBtn) {
          deleteTodayBtn.addEventListener("click", async () => {
            const today = keyBase();
            if (
              confirm(
                `ä»Šæ—¥ï¼ˆ${today}ï¼‰ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`
              )
            ) {
              try {
                const ok = await ensureLogin();
                if (!ok) return;

                // å½“æ—¥åˆ†ã®å…¨ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆYYYY-MM-DD-<n>ï¼‰ã¨åŸºæº–ã‚­ãƒ¼ï¼ˆYYYY-MM-DDï¼‰ã‚’å‰Šé™¤
                const res = await fetch("/api/logs");
                const logs = res.ok ? await res.json() : [];
                const targets = (logs || []).filter(
                  (log) =>
                    log?.dateKey &&
                    (log.dateKey === today ||
                      log.dateKey.startsWith(today + "-"))
                );
                for (const t of targets) {
                  await fetch(`/api/logs/${encodeURIComponent(t.dateKey)}`, {
                    method: "DELETE",
                  });
                }

                await renderLogTable();
                // UIã‚‚ãƒªã‚»ãƒƒãƒˆ
                document
                  .querySelectorAll('input[type="checkbox"]')
                  .forEach((cb) => {
                    cb.checked = false;
                  });
                document
                  .querySelectorAll("input[id$='Count']")
                  .forEach((inp) => (inp.value = "0"));
                const noteEl = document.getElementById("note");
                if (noteEl) noteEl.value = "";
                updateProgress();
                alert("ä»Šæ—¥ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
              } catch (e) {
                console.warn("Delete today log failed:", e);
                alert("å‰Šé™¤å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
              }
            }
          });
        }

        // JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³
        const exportJsonBtn = document.getElementById("exportJson");
        if (exportJsonBtn) {
          exportJsonBtn.addEventListener("click", async () => {
            const logs = await getJournal();
            const blob = new Blob([JSON.stringify(logs, null, 2)], {
              type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `workout-logs-${new Date()
              .toISOString()
              .slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          });
        }
      }

      // çŠ¶æ…‹å¾©å…ƒ
      async function restoreState() {
        const state = await getState();

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
        $$(".set").forEach(async (ch) => {
          const key = `set.${ch.dataset.key}`;
          ch.checked = !!state[key];
        });

        $$(".str").forEach(async (ch) => {
          const key = `str.${ch.dataset.key}`;
          ch.checked = !!state[key];
        });

        // ãƒ¡ã‚¤ãƒ³å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
        const strengthDoneEl = $("#strengthDone");
        const stretchDoneEl = $("#stretchDone");
        const bikeDoneEl = $("#bikeDone");

        if (strengthDoneEl) strengthDoneEl.checked = !!state.strengthDone;
        if (stretchDoneEl) stretchDoneEl.checked = !!state.stretchDone;
        if (bikeDoneEl) bikeDoneEl.checked = !!state.bikeDone;

        // è¿½åŠ : å†èª­ã¿è¾¼ã¿æ™‚ã§ã‚‚ã€Œå…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼å®Œäº†ã€ã®çŠ¶æ…‹ã‚’å€‹åˆ¥é …ç›®ã«åæ˜ 
        if (state.strengthDone) {
          const strengthSets = [
            "sq-1",
            "sq-2",
            "pu-1",
            "pu-2",
            "pl-1",
            "pl-2",
            "pl-3",
            "bd-1",
            "bd-2",
            "mc-1",
            "mc-2",
          ];
          strengthSets.forEach((setKey) => {
            const el = document.querySelector(`.set[data-key="${setKey}"]`);
            if (el) el.checked = true; // UIã«ç¢ºå®Ÿã«åæ˜ ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆé€å‡ºã¯ä¸è¦ï¼‰
          });
        }
        if (state.stretchDone) {
          const stretchParts = [
            "st-thigh",
            "st-calf",
            "st-shoulder",
            "st-chest",
          ];
          stretchParts.forEach((partKey) => {
            const el = document.querySelector(`.str[data-key="${partKey}"]`);
            if (el) el.checked = true;
          });
        }

        // ã‚»ãƒƒãƒˆæ•°ã®å¾©å…ƒ
        if (state.sets) {
          Object.entries(state.sets).forEach(([key, value]) => {
            const input = $(`#${key}Count`);
            if (input) input.value = value || 0;
          });
        }

        // ãƒ¡ãƒ¢ã®å¾©å…ƒ
        const noteEl = $("#note");
        if (noteEl && state.note) {
          noteEl.value = state.note;
        }

        updateProgress();
      }
      // --- ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç¢ºèªï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¯¾å¿œï¼‰ ---
      async function ensureLogin() {
        const me = await fetch("/api/me")
          .then((r) => r.json())
          .catch(() => ({ user: null }));

        if (me.user) {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¡¨ç¤º
          updateUserDisplay(me.user);
          return true;
        }

        // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        window.location.href = "/login";
        return false;
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºã®æ›´æ–°
      function updateUserDisplay(username) {
        // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        const header = document.querySelector("header");
        if (header && !document.getElementById("user-info")) {
          const userInfo = document.createElement("div");
          userInfo.id = "user-info";
          userInfo.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="color: var(--accent); font-weight: 600;">ğŸ‘¤ ${username}</span>
              <button onclick="logout()" style="
                background: var(--danger);
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
              ">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
          `;
          header.appendChild(userInfo);
        }
      }

      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
      async function logout() {
        try {
          await fetch("/api/logout", { method: "POST" });
          window.location.href = "/login";
        } catch (error) {
          console.error("Logout error:", error);
          window.location.href = "/login";
        }
      }

      // ã‚µãƒ¼ãƒãƒ¼ã¸ã€Œä»Šæ—¥ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã€ã‚’é€ã‚‹
      async function pushTodayToServer(entry) {
        const ok = await ensureLogin();
        if (!ok) return;

        const response = await fetch("/api/logs/upsert", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(entry),
        });

        if (!response.ok) {
          // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
          let errorMessage = `Server error: ${response.status}`;
          try {
            const errorData = await response.json();
            if (errorData.error) {
              errorMessage = errorData.error;
            }
          } catch (e) {
            // JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ç”¨
          }
          throw new Error(errorMessage);
        }
        // console.log('Server upsert OK');
      }

      // ã‚µãƒ¼ãƒãƒ¼ã®ä¸€è¦§ã‚’å–å¾—ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã«åæ˜ 
      async function fetchLogsFromServer() {
        try {
          const ok = await ensureLogin();
          if (!ok) return;
          const res = await fetch("/api/logs");
          if (!res.ok) throw new Error(`Server error: ${res.status}`);
          const list = await res.json();
          // ã‚µãƒ¼ãƒãƒ¼ãŒçœŸå®Ÿã®ã‚½ãƒ¼ã‚¹: ãƒ­ãƒ¼ã‚«ãƒ«ã‚’ç½®ãæ›ãˆ
          setJournal(Array.isArray(list) ? list : []);
          renderLogTable();
        } catch (e) {
          console.warn("Failed to fetch logs from server:", e);
        }
      }

      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸæœ€æ–°ãƒ‡ãƒ¼ã‚¿ã®ã¿ã§æç”»
      async function renderLogTable() {
        const tbody = document.querySelector("#logTable tbody");
        if (!tbody) return;
        tbody.innerHTML = "";
        let logs = [];
        try {
          const ok = await ensureLogin();
          if (!ok) return;
          const res = await fetch("/api/logs");
          if (!res.ok) throw new Error(`Server error: ${res.status}`);
          logs = await res.json();
          setJournal(Array.isArray(logs) ? logs : []); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨é€”
        } catch (e) {
          // ã‚µãƒ¼ãƒãƒ¼å–å¾—å¤±æ•—æ™‚ã®ã¿ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¡¨ç¤º
          logs = getJournal();
        }
        console.log("[DEBUG] renderLogTable logs:", logs);
        console.log(
          `[DEBUG] APIã‹ã‚‰å–å¾—ã—ãŸå…¨ãƒ­ã‚°ä»¶æ•°: ${logs ? logs.length : 0}`
        );
        // actionãŒ"workout"ã®è¨˜éŒ²ã®ã¿è¡¨ç¤º
        logs = (logs || [])
          .filter((lg) => lg.action === "workout") // é‹å‹•è¨˜éŒ²ã®ã¿æŠ½å‡º
          .slice()
          .sort((a, b) => {
            const ak = a.dateKey || (a.date ? a.date.slice(0, 10) : "");
            const bk = b.dateKey || (b.date ? b.date.slice(0, 10) : "");
            if (ak === bk) return (b.date || "").localeCompare(a.date || "");
            return bk.localeCompare(ak);
          });
        console.log(`[DEBUG] workoutè¨˜éŒ²ã®ãƒ•ã‚£ãƒ«ã‚¿å¾Œä»¶æ•°: ${logs.length}`);
        logs.forEach((log, index) => {
          console.log(
            `  ${index + 1}. dateKey: ${log.dateKey}, action: ${log.action}`
          );
        });
        if (logs.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="4" style="padding:10px; color:#9fb2d9;">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ã®ã€Œä»Šæ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜ã€ã‚’æŠ¼ã™ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</td>`;
          tbody.appendChild(tr);
          return;
        }
        logs.forEach((lg) => {
          const tr = document.createElement("tr");
          tr.style.borderBottom = "1px solid #223259";
          const dt = new Date(lg.date || `${lg.dateKey}T00:00:00`);
          const dtStr = isNaN(dt.getTime())
            ? lg.dateKey || "-"
            : dt.toLocaleString("ja-JP", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
              });
          // é€²æ—æ¬„ã®è¡¨ç¤ºã‚’å‹ã§åˆ†å²
          let progressCell = "-";
          if (typeof lg.progress === "number" && !isNaN(lg.progress)) {
            progressCell = `${lg.progress}%`;
          }
          tr.innerHTML = `
            <td style="padding:8px;">${dtStr}</td>
            <td style="padding:8px;">${progressCell}</td>
            <td style="padding:8px; max-width:320px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${(
              lg.note || ""
            ).replace(/"/g, "&quot;")}">${lg.note || ""}</td>
            <td style="padding:8px;"><button class="btn ghost small" data-datekey="${
              lg.dateKey
            }">å‰Šé™¤</button></td>
          `;
          tr.querySelector("button").addEventListener("click", async (e) => {
            const key = e.target.dataset.datekey;
            if (confirm("ã“ã®æ—¥ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
              try {
                const ok = await ensureLogin();
                if (ok) {
                  await fetch(`/api/logs/${encodeURIComponent(key)}`, {
                    method: "DELETE",
                  });
                  await renderLogTable();
                }
              } catch (err) {
                console.warn("Failed to delete on server:", err);
              }
            }
          });
          tbody.appendChild(tr);
        });
      }

      // ä»Šæ—¥ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ï¼ˆå½“æ—¥æœ€å¤§3ä»¶: YYYY-MM-DD-1..3ï¼‰
      async function saveTodaySnapshot(silent = false) {
        try {
          const ok = await ensureLogin();
          if (!ok) return;

          // ç¾åœ¨ã®UIçŠ¶æ…‹ã‚’åé›†
          const state = await getState();
          const sets = collectSets();
          const stretchParts = collectStretch();

          // é€²æ—ç‡ã‚’å†è¨ˆç®—ï¼ˆå°é …ç›®ãƒ™ãƒ¼ã‚¹ï¼‰
          const s = {
            bikeDone: document.getElementById("bikeDone")?.checked || false,
            strengthDone:
              document.getElementById("strengthDone")?.checked || false,
            stretchDone:
              document.getElementById("stretchDone")?.checked || false,
          };

          // ç­‹ãƒˆãƒ¬ï¼šå…¨ã‚»ãƒƒãƒˆãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          const strengthSets = [
            "sq-1",
            "sq-2",
            "pu-1",
            "pu-2",
            "pl-1",
            "pl-2",
            "pl-3",
            "bd-1",
            "bd-2",
            "mc-1",
            "mc-2",
          ];
          const completedStrengthSets = strengthSets.filter(
            (setKey) => sets[setKey] > 0
          ).length;
          const strengthCompleted =
            completedStrengthSets === strengthSets.length;

          // ã‚¹ãƒˆãƒ¬ãƒƒãƒï¼šå…¨éƒ¨ä½ãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          const stretchKeys = Object.keys(stretchParts);
          const completedStretchParts = stretchKeys.filter(
            (key) => stretchParts[key]
          ).length;
          const stretchCompleted =
            stretchKeys.length > 0 &&
            completedStretchParts === stretchKeys.length;

          // å…¨é …ç›®ãŒå®Œäº†ã—ãŸå ´åˆã¯100%ã«ã™ã‚‹ï¼ˆå°é …ç›®ãƒ™ãƒ¼ã‚¹ï¼‰
          const allItemsCompleted =
            s.bikeDone && strengthCompleted && stretchCompleted;
          let totalProgress;

          if (allItemsCompleted) {
            totalProgress = 100;
          } else {
            // 3ã¤ã®ä¸»è¦ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®å®Œäº†ç‡ã‚’è¨ˆç®—ï¼ˆå„ã€…33.3%ã®é‡ã¿ï¼‰
            const bikeProgress = s.bikeDone ? 1 : 0;
            const strengthProgress =
              strengthSets.length > 0
                ? completedStrengthSets / strengthSets.length
                : 0;
            const stretchProgress =
              stretchKeys.length > 0
                ? completedStretchParts / stretchKeys.length
                : 0;

            totalProgress = Math.round(
              (100 * (bikeProgress + strengthProgress + stretchProgress)) / 3
            );
          }

          // --- ã“ã“ã‹ã‚‰: å½“æ—¥æœ€å¤§3ä»¶ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆ ---
          const today = keyBase(); // YYYY-MM-DD
          let nextIndex = 0;
          try {
            // å½“æ—¥ã®æ—¢å­˜ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆYYYY-MM-DD-<n>ï¼‰ã‚’å–å¾—ã—ã¦ç©ºãç•ªå·ã‚’æ±ºã‚ã‚‹
            const r = await fetch("/api/logs");
            if (r.ok) {
              const logs = await r.json();
              const todays = (logs || []).filter(
                (l) =>
                  l &&
                  typeof l.dateKey === "string" &&
                  l.dateKey.startsWith(today + "-") &&
                  // workoutã®ã¿ã‚’å¯¾è±¡ï¼ˆä»–ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯é™¤å¤–ï¼‰
                  (l.action === "workout" || typeof l.action === "undefined")
              );
              const used = new Set(
                todays
                  .map((l) => Number(String(l.dateKey).split("-").pop()))
                  .filter((n) => !isNaN(n))
              );
              for (let i = 1; i <= 3; i++) {
                if (!used.has(i)) {
                  nextIndex = i;
                  break;
                }
              }
            }
          } catch (_) {
            // å–å¾—å¤±æ•—æ™‚ã¯1ä»¶ç›®ã¨ã—ã¦æ‰±ã†
            nextIndex = 1;
          }

          if (!nextIndex) {
            if (!silent) alert("æœ¬æ—¥ã®ä¿å­˜ä¸Šé™ï¼ˆ3ä»¶ï¼‰ã«é”ã—ã¾ã—ãŸã€‚");
            return;
          }

          const snapshotDateKey = `${today}-${nextIndex}`; // ä¾‹) 2025-08-14-1

          // ã‚µãƒ¼ãƒãƒ¼ã«é€ã‚‹ã‚¨ãƒ³ãƒˆãƒªï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰
          const entry = {
            date: new Date().toISOString(),
            dateKey: snapshotDateKey,
            progress: totalProgress,
            bikeDone: s.bikeDone,
            strengthDone: s.strengthDone,
            stretchDone: s.stretchDone,
            hiit: !!document.querySelector("#hiitToggle")?.checked,
            sets: sets,
            stretchParts: stretchParts,
            note: document.querySelector("#note")?.value || "",
          };

          // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯dateKeyãªã®ã§æ–°è¦ä½œæˆã«ãªã‚‹ï¼‰
          await pushTodayToServer(entry);

          // ä½µã›ã¦ã€Œä½œæ¥­ç”¨ã®å½“æ—¥ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆYYYY-MM-DDï¼‰ã€ã‚‚æœ€æ–°çŠ¶æ…‹ã§æ›´æ–°
          await setState({
            ...state,
            sets,
            stretchParts,
            bikeDone: s.bikeDone,
            strengthDone: s.strengthDone,
            stretchDone: s.stretchDone,
            note: document.querySelector("#note")?.value || "",
          });

          if (!silent) {
            alert(`ä»Šæ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆ${nextIndex}/3ä»¶ç›®ï¼‰ã€‚`);
            await renderLogTable();
          }
        } catch (e) {
          console.warn("Save snapshot failed:", e);
          if (!silent) {
            const errorMessage =
              e.message || "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚";
            alert(errorMessage);
          }
        }
      }

      // è‡ªå‹•ä¿å­˜ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼
      function scheduleAutoSave() {
        if (autoSaveTimer) clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
          saveTodaySnapshot(true); // silent mode
        }, 2000); // 2ç§’å¾Œã«è‡ªå‹•ä¿å­˜
      }

      // åŒæ—¥ã®æœ€æ–°ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆè¨˜éŒ²ã‹ã‚‰çŠ¶æ…‹ã‚’å¾©å…ƒ
      async function restoreFromLatestWorkout() {
        try {
          const ok = await ensureLogin();
          if (!ok) return;

          const response = await fetch("/api/logs");
          if (!response.ok) return;

          const logs = await response.json();
          const today = keyBase();

          // ä»Šæ—¥ã®ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆè¨˜éŒ²ã‚’æ¤œç´¢ï¼ˆloginä»¥å¤–ï¼‰
          const todayWorkouts = logs.filter(
            (log) =>
              log.dateKey &&
              log.dateKey.startsWith(today) &&
              !log.dateKey.includes("login")
          );

          if (todayWorkouts.length === 0) return;

          // æœ€æ–°ã®ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆè¨˜éŒ²ã‚’å–å¾—
          const latestWorkout = todayWorkouts.sort(
            (a, b) => new Date(b.date) - new Date(a.date)
          )[0];

          console.log("æœ€æ–°ã®ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆè¨˜éŒ²ã‹ã‚‰çŠ¶æ…‹ã‚’å¾©å…ƒ:", latestWorkout);

          // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
          if (latestWorkout.bikeDone !== undefined) {
            const bikeDoneEl = $("#bikeDone");
            if (bikeDoneEl) bikeDoneEl.checked = latestWorkout.bikeDone;
          }

          if (latestWorkout.strengthDone !== undefined) {
            const strengthDoneEl = $("#strengthDone");
            if (strengthDoneEl)
              strengthDoneEl.checked = latestWorkout.strengthDone;
          }

          if (latestWorkout.stretchDone !== undefined) {
            const stretchDoneEl = $("#stretchDone");
            if (stretchDoneEl)
              stretchDoneEl.checked = latestWorkout.stretchDone;
          }

          // å€‹åˆ¥ã‚»ãƒƒãƒˆã®çŠ¶æ…‹ã‚’å¾©å…ƒ
          if (latestWorkout.sets) {
            Object.entries(latestWorkout.sets).forEach(([key, value]) => {
              const countEl = $(`#${key}Count`);
              if (countEl) countEl.value = value || 0;
            });
          }

          // ã‚¹ãƒˆãƒ¬ãƒƒãƒéƒ¨ä½ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
          if (latestWorkout.stretchParts) {
            Object.entries(latestWorkout.stretchParts).forEach(
              ([key, checked]) => {
                const el = $(`.str[data-key="${key}"]`);
                if (el) el.checked = !!checked;
              }
            );
          }

          // HIITã®çŠ¶æ…‹ã‚’å¾©å…ƒ
          if (latestWorkout.hiit !== undefined) {
            const hiitEl = $("#hiitToggle");
            if (hiitEl) hiitEl.checked = latestWorkout.hiit;
          }

          // ãƒ¡ãƒ¢ã®å¾©å…ƒ
          if (latestWorkout.note) {
            const noteEl = $("#note");
            if (noteEl) noteEl.value = latestWorkout.note;
          }

          // é€²æ—ã‚’æ›´æ–°
          updateProgress();
        } catch (error) {
          console.warn("ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã®å¾©å…ƒã«å¤±æ•—:", error);
        }
      }

      // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æºã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      async function setupDatabaseEventListeners() {
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        $$(".set").forEach((ch) => {
          ch.addEventListener("change", async (e) => {
            const state = await getState();
            const key = `set.${ch.dataset.key}`;
            state[key] = e.target.checked;
            await setState(state);
            updateProgress();
            scheduleAutoSave();
          });
        });

        $$(".str").forEach((ch) => {
          ch.addEventListener("change", async (e) => {
            const state = await getState();
            const key = `str.${ch.dataset.key}`;
            state[key] = e.target.checked;
            await setState(state);
            updateProgress();
            scheduleAutoSave();
          });
        });

        // ã‚»ãƒƒãƒˆæ•°å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        $$("input[id$='Count']").forEach((input) => {
          input.addEventListener("input", async (e) => {
            const state = await getState();
            if (!state.sets) state.sets = {};
            const key = e.target.id.replace("Count", "");
            state.sets[key] = parseInt(e.target.value || "0", 10);
            await setState(state);
            updateProgress();
            scheduleAutoSave();
          });
        });

        // ãƒ¡ã‚¤ãƒ³å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
        const strengthDoneEl = $("#strengthDone");
        const stretchDoneEl = $("#stretchDone");
        const bikeDoneEl = $("#bikeDone");

        if (strengthDoneEl) {
          strengthDoneEl.addEventListener("change", async (e) => {
            const isChecked = e.target.checked;

            // ç­‹ãƒˆãƒ¬å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼å®Œäº†ãŒãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã€å…¨ã¦ã®ç­‹ãƒˆãƒ¬ã‚»ãƒƒãƒˆã«ã‚‚ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹
            if (isChecked) {
              console.log(
                "[DEBUG] ç­‹ãƒˆãƒ¬å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼å®Œäº†: å…¨ã‚»ãƒƒãƒˆã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¾ã™"
              );
              const strengthSets = [
                "sq-1",
                "sq-2",
                "pu-1",
                "pu-2",
                "pl-1",
                "pl-2",
                "pl-3",
                "bd-1",
                "bd-2",
                "mc-1",
                "mc-2",
              ];

              strengthSets.forEach((setKey) => {
                const setEl = $(`.set[data-key="${setKey}"]`);
                if (setEl && !setEl.checked) {
                  setEl.checked = true;
                  // å€‹åˆ¥ã‚»ãƒƒãƒˆã®çŠ¶æ…‹ã‚‚æ›´æ–°
                  setEl.dispatchEvent(new Event("change"));
                }
              });
            }

            await mark("strengthDone", isChecked);
          });
        }

        if (stretchDoneEl) {
          stretchDoneEl.addEventListener("change", async (e) => {
            const isChecked = e.target.checked;

            // ã‚¹ãƒˆãƒ¬ãƒƒãƒå®Œäº†ãŒãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã€å…¨ã¦ã®ã‚¹ãƒˆãƒ¬ãƒƒãƒéƒ¨ä½ã«ã‚‚ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹
            if (isChecked) {
              console.log("[DEBUG] ã‚¹ãƒˆãƒ¬ãƒƒãƒå®Œäº†: å…¨éƒ¨ä½ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¾ã™");
              const stretchParts = [
                "st-thigh",
                "st-calf",
                "st-shoulder",
                "st-chest",
              ];

              stretchParts.forEach((partKey) => {
                const partEl = $(`.str[data-key="${partKey}"]`);
                if (partEl && !partEl.checked) {
                  partEl.checked = true;
                  // å€‹åˆ¥éƒ¨ä½ã®çŠ¶æ…‹ã‚‚æ›´æ–°
                  partEl.dispatchEvent(new Event("change"));
                }
              });
            }

            await mark("stretchDone", isChecked);
          });
        }

        if (bikeDoneEl) {
          bikeDoneEl.addEventListener("change", async (e) => {
            await mark("bikeDone", e.target.checked);
          });
        }

        // ãƒ¡ãƒ¢æ¬„ã®è‡ªå‹•ä¿å­˜
        const noteEl = $("#note");
        if (noteEl) {
          noteEl.addEventListener("input", () => {
            scheduleAutoSave();
          });
        }

        // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
        const resetDayBtn = $("#resetDay");
        if (resetDayBtn) {
          resetDayBtn.addEventListener("click", async () => {
            if (!confirm("æœ¬æ—¥ã®è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;

            try {
              const dateKey = keyBase();
              await fetch(`/api/logs/${dateKey}`, { method: "DELETE" });

              // UIã‚’ãƒªã‚»ãƒƒãƒˆ
              $$(".set, .str").forEach((ch) => (ch.checked = false));
              $$("input[id$='Count']").forEach((input) => (input.value = "0"));
              if (bikeDoneEl) bikeDoneEl.checked = false;
              if (strengthDoneEl) strengthDoneEl.checked = false;
              if (stretchDoneEl) stretchDoneEl.checked = false;
              if (noteEl) noteEl.value = "";

              updateProgress();
              await renderLogTable();
            } catch (e) {
              console.warn("Reset failed:", e);
            }
          });
        }
      }

      // åˆæœŸåŒ–å‡¦ç†ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸­å¿ƒï¼‰
      window.addEventListener("DOMContentLoaded", async () => {
        console.log("DOM loaded, initializing with database integration...");

        // ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª
        const ok = await ensureLogin();
        if (!ok) return;

        // UIåˆæœŸåŒ–
        initializeToday();
        setupEventListeners();

        // çŠ¶æ…‹å¾©å…ƒï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ï¼‰
        await restoreState();

        // åŒæ—¥ã®æœ€æ–°ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆè¨˜éŒ²ã‹ã‚‰çŠ¶æ…‹ã‚’å¾©å…ƒ
        await restoreFromLatestWorkout();

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æºï¼‰
        await setupDatabaseEventListeners();

        // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        await renderLogTable();
      });
    </script>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="title">
          ğŸ ãŠã†ã¡ã§ç­‹ãƒˆãƒ¬ <span class="muted" id="greet"></span>
        </div>
        <div class="chipbar">
          <span class="chip">ä»Šæ—¥ï¼š<b id="today"></b></span>
          <span class="chip chip-mobile-full"
            >ç›®æ¨™ï¼šæœ‰é…¸ç´ 30åˆ†ï¼‹ç­‹ãƒˆãƒ¬ï¼‹ã‚¹ãƒˆãƒ¬ãƒƒãƒ</span
          >
          <span class="chip">é€²æ—ï¼š<b id="progressText">0%</b></span>
        </div>
      </header>
      <div class="card" style="margin-bottom: 12px">
        <div class="row" style="justify-content: space-between">
          <div class="row">
            <span class="tag">RPM 70â€“80</span>
            <span class="tag">è² è· 40â€“60%</span>
            <span class="tag">å¿ƒæ‹ 120â€“140ï¼ˆä¼šè©±OKï¼‰</span>
          </div>
          <div class="switch">
            <label class="small"
              ><input id="hiitToggle" type="checkbox" /> HIITãƒ–ãƒ¼ã‚¹ãƒˆï¼ˆä¸­ç›¤5åˆ†
              60â€“70%ï¼‰</label
            >
            <button class="btn secondary" id="resetDay">
              æœ¬æ—¥ã®è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆ
            </button>
          </div>
        </div>
        <div class="progress" style="margin-top: 10px">
          <span id="progressBar"></span>
        </div>
      </div>
      <div class="grid">
        <!-- Aerobike -->
        <section class="card span-7" id="bike">
          <h2>1. æœ‰é…¸ç´ ï¼ˆã‚¨ã‚¢ãƒ­ãƒã‚¤ã‚¯ï¼‰30åˆ†</h2>
          <div class="muted">
            ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—3åˆ† â†’ ä¸­å¼·åº¦22åˆ† â†’ ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³5åˆ†
          </div>
          <div class="timer">
            <div class="clock" id="clock">00:00</div>
            <div class="row">
              <button class="btn" id="start">â–¶ é–‹å§‹</button>
              <button class="btn secondary" id="pause">â¸ ä¸€æ™‚åœæ­¢</button>
              <button class="btn ghost" id="reset">âŸ² ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </div>
          <div class="seglist" id="segments"></div>
          <div class="kpi">
            <div class="pill">å›è»¢æ•°ï¼š<b>70â€“80 rpm</b></div>
            <div class="pill">è² è·ï¼š<b>40â€“60%</b></div>
            <div class="pill">ä¼šè©±ã§ãã‚‹å¼·åº¦</div>
          </div>
          <label class="small"
            ><input id="bikeDone" type="checkbox" /> æœ‰é…¸ç´ 30åˆ† å®Œäº†</label
          >
          <div class="note">
            ãƒ’ãƒ³ãƒˆï¼šåºç›¤ã¯é¼»å‘¼å¸ï¼‹è…¹å¼ã§å¿ƒæ‹ã‚’å®‰å®šã€‚ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹ä¸€å®šã‚’å„ªå…ˆã—ã€è² è·ã§å¾®èª¿æ•´ã€‚
          </div>
        </section>

        <!-- Strength -->
        <section class="card span-5" id="strength">
          <h2>2. ç­‹ãƒˆãƒ¬ï¼ˆãƒ•ã‚©ãƒ¼ãƒ é‡è¦–ï¼‰</h2>
          <div class="list">
            <div class="ex">
              <div class="meta">
                <b
                  ><a
                    href="https://www.youtube.com/watch?v=Wjp7V0EK0Zg"
                    style="color: inherit; text-decoration: underline"
                    target="_blank"
                    rel="noopener"
                    >2-1. ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ</a
                  ></b
                >
                <span class="tag">15å› Ã— 2ã‚»ãƒƒãƒˆ</span>
                <div class="steps">
                  è‚©å¹…ãƒ»èƒŒç­‹ã¾ã£ã™ãï¼è†ãŒã¤ã¾å…ˆã‚ˆã‚Šå‰ã«å‡ºãªã„ï¼å¤ªã‚‚ã‚‚ãŒåºŠã¨å¹³è¡Œâ†’ã‹ã‹ã¨ã§æŠ¼ã™
                </div>
              </div>
              <div class="checkset">
                <label
                  ><input class="set" data-key="sq-1" type="checkbox" />
                  1</label
                >
                <label
                  ><input class="set" data-key="sq-2" type="checkbox" />
                  2</label
                >
              </div>
            </div>
            <div class="ex">
              <div class="meta">
                <b
                  ><a
                    href="https://www.youtube.com/watch?v=IdQESpQE9ew"
                    style="color: inherit; text-decoration: underline"
                    target="_blank"
                    rel="noopener"
                    >2-2. ãƒ—ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—</a
                  ></b
                >
                <span class="tag">10â€“15å› Ã— 2ã‚»ãƒƒãƒˆ</span>
                <div class="steps">
                  æ‰‹å¹…ã‚„ã‚„åºƒã‚ï¼é ­ã€œã‹ã‹ã¨ä¸€ç›´ç·šï¼ˆè†ã¤ãå¯ï¼‰ï¼èƒ¸ã‚’åºŠã‚¹ãƒ¬ã‚¹ãƒ¬ã¾ã§
                </div>
              </div>
              <div class="checkset">
                <label
                  ><input class="set" data-key="pu-1" type="checkbox" />
                  1</label
                >
                <label
                  ><input class="set" data-key="pu-2" type="checkbox" />
                  2</label
                >
              </div>
            </div>
            <div class="ex">
              <div class="meta">
                <b
                  ><a
                    href="https://www.youtube.com/watch?v=UgkU2S8VUX4"
                    style="color: inherit; text-decoration: underline"
                    target="_blank"
                    rel="noopener"
                    >2-3. ãƒ—ãƒ©ãƒ³ã‚¯</a
                  ></b
                >
                <span class="tag">30ç§’ Ã— 3ã‚»ãƒƒãƒˆ</span>
                <div class="steps">
                  è‚˜ã¯è‚©ã®çœŸä¸‹ï¼é ­ã€œã‹ã‹ã¨ä¸€ç›´ç·šï¼è…¹åœ§ã§è…°ã‚’è½ã¨ã•ãªã„
                </div>
              </div>
              <div class="checkset">
                <label
                  ><input class="set" data-key="pl-1" type="checkbox" />
                  1</label
                >
                <label
                  ><input class="set" data-key="pl-2" type="checkbox" />
                  2</label
                >
                <label
                  ><input class="set" data-key="pl-3" type="checkbox" />
                  3</label
                >
                <button class="btn ghost small" id="plank30">
                  â–¶ 30ç§’ã‚¿ã‚¤ãƒãƒ¼
                </button>
              </div>
            </div>
            <div class="ex">
              <div class="meta">
                <b
                  ><a
                    href="https://www.youtube.com/watch?v=FvU7izWY358"
                    style="color: inherit; text-decoration: underline"
                    target="_blank"
                    rel="noopener"
                    >2-4. ãƒãƒ¼ãƒ‰ãƒ‰ãƒƒã‚°</a
                  ></b
                >
                <span class="tag">å·¦å³10å›ãšã¤ Ã— 2ã‚»ãƒƒãƒˆ</span>
                <div class="steps">
                  å››ã¤ã‚“é€™ã„ï¼åå¯¾ã®æ‰‹è¶³ã‚’ã¾ã£ã™ãï¼è…°é«˜ã‚’å¤‰ãˆãšä½“å¹¹å®‰å®š
                </div>
              </div>
              <div class="checkset">
                <label
                  ><input class="set" data-key="bd-1" type="checkbox" />
                  1</label
                >
                <label
                  ><input class="set" data-key="bd-2" type="checkbox" />
                  2</label
                >
              </div>
            </div>
            <div class="ex">
              <div class="meta">
                <b
                  ><a
                    href="https://www.youtube.com/shorts/Nzbrmw71HdY"
                    style="color: inherit; text-decoration: underline"
                    target="_blank"
                    rel="noopener"
                    >2-5. ãƒã‚¦ãƒ³ãƒ†ãƒ³ã‚¯ãƒ©ã‚¤ãƒãƒ¼</a
                  ></b
                >
                <span class="tag">å·¦å³20å›ãšã¤ Ã— 2ã‚»ãƒƒãƒˆ</span>
                <div class="steps">
                  ãƒ—ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—å§¿å‹¢ï¼è†ã‚’èƒ¸ã«å¼•ãå¯„ã›ç´ æ—©ãå…¥æ›¿ï¼è…°ã®ä¸Šä¸‹ã¯æœ€å°ã«
                </div>
              </div>
              <div class="checkset">
                <label
                  ><input class="set" data-key="mc-1" type="checkbox" />
                  1</label
                >
                <label
                  ><input class="set" data-key="mc-2" type="checkbox" />
                  2</label
                >
              </div>
            </div>
            <label class="small"
              ><input id="strengthDone" type="checkbox" /> ç­‹ãƒˆãƒ¬ å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼
              å®Œäº†</label
            >
          </div>
        </section>
        <!-- Stretch -->
        <section class="card span-12" id="stretch">
          <h2>3. ã‚¹ãƒˆãƒ¬ãƒƒãƒï¼ˆ2ã€œ3åˆ†ï¼‰</h2>
          <div class="list">
            <label class="small"
              ><input class="str" data-key="st-thigh" type="checkbox" />
              å¤ªã‚‚ã‚‚å‰å¾Œ</label
            >
            <label class="small"
              ><input class="str" data-key="st-calf" type="checkbox" />
              ãµãã‚‰ã¯ã</label
            >
            <label class="small"
              ><input class="str" data-key="st-shoulder" type="checkbox" />
              è‚©ãƒ»èƒŒä¸­</label
            >
            <label class="small"
              ><input class="str" data-key="st-chest" type="checkbox" />
              èƒ¸</label
            >
            <div class="note">
              åå‹•ã‚’ã¤ã‘ãšã€æ·±å‘¼å¸ã—ãªãŒã‚‰15â€“20ç§’ã‚­ãƒ¼ãƒ—ã‚’æ•°ã‚»ãƒƒãƒˆã€‚
            </div>
            <label class="small"
              ><input id="stretchDone" type="checkbox" /> ã‚¹ãƒˆãƒ¬ãƒƒãƒ å®Œäº†</label
            >
          </div>
        </section>
        <section class="card span-12" id="journal">
          <h2>4. æ—¥æ¬¡ãƒ­ã‚°ï¼ˆä¿å­˜ãƒ»å±¥æ­´ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰</h2>
          <div
            class="row"
            style="align-items: stretch; gap: 12px; margin: 8px 0"
          >
            <textarea
              id="note"
              placeholder="ä»Šæ—¥ã®ãƒ¡ãƒ¢ï¼ˆä½“èª¿ã€è² è·ã€æ°—ã¥ãç­‰ï¼‰"
              style="
                flex: 1;
                min-height: 70px;
                border-radius: 12px;
                border: 1px solid #223259;
                background: #0f1831;
                color: #eaf1ff;
                padding: 10px;
              "
            ></textarea>
            <div style="display: flex; flex-direction: column; gap: 8px">
              <button class="btn" id="saveLog">ğŸ’¾ ä»Šæ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜</button>
              <button class="btn secondary" id="deleteTodayLog">
                ğŸ—‘ ä»Šæ—¥ã®è¨˜éŒ²ã‚’å‰Šé™¤
              </button>
              <button class="btn secondary" id="exportCsv">
                ğŸ“¤ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
              </button>
              <button class="btn ghost" id="clearAllLogs">
                ğŸ—‘ ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤
              </button>
            </div>
          </div>
          <div class="row" style="gap: 8px; margin: 6px 0 0">
            <input
              accept="application/json"
              id="importJsonFile"
              style="display: none"
              type="file"
            />
            <button class="btn secondary" id="exportJson">
              ğŸ§° JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
            </button>
            <button class="btn ghost" id="importJson">ğŸ“¥ JSONèª­ã¿è¾¼ã¿</button>
          </div>
          <div class="list">
            <div class="small muted">
              â€» ä¿å­˜ã™ã‚‹ã¨ä¸‹ã®å±¥æ­´ã«è¿½åŠ ã•ã‚Œã¾ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ï¼‰ã€‚
            </div>
            <div class="log-table-wrap">
              <table
                id="logTable"
                style="width: 100%; border-collapse: collapse; font-size: 13px"
              >
                <thead>
                  <tr style="background: #0b1328">
                    <th
                      style="
                        padding: 8px;
                        text-align: left;
                        border-bottom: 1px solid #223259;
                      "
                    >
                      æ—¥æ™‚
                    </th>
                    <th
                      style="
                        padding: 8px;
                        text-align: left;
                        border-bottom: 1px solid #223259;
                      "
                    >
                      é€²æ—(%)
                    </th>
                    <th
                      style="
                        padding: 8px;
                        text-align: left;
                        border-bottom: 1px solid #223259;
                      "
                    >
                      ãƒ¡ãƒ¢
                    </th>
                    <th
                      style="
                        padding: 8px;
                        text-align: left;
                        border-bottom: 1px solid #223259;
                      "
                    >
                      æ“ä½œ
                    </th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- é€²æ—å®Ÿç¸¾ãƒãƒ£ãƒ¼ãƒˆ -->
        <section class="card span-12" id="progressChart">
          <h2>5. é€²æ—å®Ÿç¸¾ãƒãƒ£ãƒ¼ãƒˆ</h2>
          <div class="row" style="gap: 12px; margin: 8px 0">
            <button class="btn secondary" id="weeklyChart">
              ğŸ“Š é€±é–“ãƒãƒ£ãƒ¼ãƒˆ
            </button>
            <button class="btn secondary" id="monthlyChart">
              ğŸ“ˆ æœˆé–“ãƒãƒ£ãƒ¼ãƒˆ
            </button>
            <button class="btn ghost" id="refreshChart">ğŸ”„ æ›´æ–°</button>
          </div>
          <div style="margin: 16px 0; height: 400px; position: relative">
            <canvas id="progressCanvas" style="max-height: 100%"></canvas>
          </div>
          <div class="note">
            éå»ã®é€²æ—ç‡ã‚’ã‚°ãƒ©ãƒ•ã§å¯è¦–åŒ–ã€‚ç¶™ç¶šã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³å‘ä¸Šã«æ´»ç”¨ã—ã¦ãã ã•ã„ã€‚
          </div>
        </section>
      </div>
    </div>
    <footer>
      <span class="quote" id="quote"
        >ã€Œæœ€åˆã®ä¸€æ­©ãŒã€ã„ã¡ã°ã‚“ä½“æ¸©ã‚’ä¸Šã’ã‚‹ã€‚ã€</span
      >
      <span class="chip" id="dailyBadge"
        >ä»Šæ—¥ã®é€£ç¶šæ—¥æ•°ï¼š<b id="streak">0</b> ğŸ”¥</span
      >
    </footer>
    <script>
      // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸­å¿ƒã®ã‚·ãƒ³ãƒ—ãƒ«ãªIIFEï¼ˆå³æ™‚å®Ÿè¡Œé–¢æ•°ï¼‰
      (function () {
        // === å¼•ç”¨æ–‡ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ ===
        const quotes = [
          "å°ã•ãå§‹ã‚ã¦ã€å¤§ããç¶šã‘ã‚‹ã€‚",
          "æ˜¨æ—¥ã‚ˆã‚Š1mmå‰ã¸ã€‚",
          "è¿·ã†ãªã‚‰ã€ã‚„ã£ã¦ã‹ã‚‰è¿·ã†ã€‚",
          "ç¶™ç¶šã¯æ‰èƒ½ã‚’è¶Šãˆã‚‹ã€‚",
          "ãƒ•ã‚©ãƒ¼ãƒ ã¯æ­£ç¾©ã€‚å›æ•°ã¯çµæœã€‚",
        ];

        function rotateQuote() {
          const quoteEl = document.querySelector("#quote");
          if (quoteEl) {
            quoteEl.textContent = `ã€Œ${
              quotes[Math.floor(Math.random() * quotes.length)]
            }ã€`;
          }
        }

        setInterval(rotateQuote, 12000);

        // === ã‚¨ã‚¢ãƒ­ãƒã‚¤ã‚¯ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ ===
        const segmentsEl = document.querySelector("#segments");
        const hiitToggle = document.querySelector("#hiitToggle");

        function baseSegments() {
          return [
            { name: "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—", mins: 3, tip: "å¿ƒæ‹100â€“110" },
            { name: "ä¸­å¼·åº¦", mins: 22, tip: "å¿ƒæ‹120â€“140" },
            { name: "ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³", mins: 5, tip: "è»½ã‚" },
          ];
        }

        function withHIIT() {
          return [
            { name: "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—", mins: 3, tip: "å¿ƒæ‹100â€“110" },
            { name: "ä¸­å¼·åº¦", mins: 8, tip: "120â€“140" },
            { name: "HIIT", mins: 5, tip: "è² è·60â€“70%" },
            { name: "ä¸­å¼·åº¦", mins: 9, tip: "120â€“140" },
            { name: "ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³", mins: 5, tip: "è»½ã‚" },
          ];
        }

        function renderSegments() {
          if (!segmentsEl || !hiitToggle) return;

          const arr = hiitToggle.checked ? withHIIT() : baseSegments();
          segmentsEl.innerHTML = "";
          arr.forEach((seg, i) => {
            const div = document.createElement("div");
            div.className = "seg";
            div.dataset.idx = i;
            div.innerHTML = `<b>${seg.name}</b>ï¼š${seg.mins}åˆ† <span class="muted">(${seg.tip})</span>`;
            segmentsEl.appendChild(div);
          });
        }

        if (hiitToggle) {
          hiitToggle.addEventListener("change", () => {
            renderSegments();
            resetTimer();
          });
        }

        renderSegments();

        // ã‚¿ã‚¤ãƒãƒ¼é–¢é€£ã®å¤‰æ•°
        let timer = null,
          totalSec = 0,
          plan = [],
          cursor = 0,
          segRemain = 0,
          running = false;

        function loadPlan() {
          if (!hiitToggle) return;

          plan = (hiitToggle.checked ? withHIIT() : baseSegments()).map(
            (s) => ({ ...s, sec: s.mins * 60 })
          );
          totalSec = plan.reduce((a, b) => a + b.sec, 0);
          cursor = 0;
          segRemain = plan[0].sec;
          highlightSeg();
          const clockEl = document.querySelector("#clock");
          if (clockEl) clockEl.textContent = fmt(totalSec);
        }

        function fmt(sec) {
          const m = Math.floor(sec / 60),
            s = sec % 60;
          return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
        }

        function highlightSeg() {
          const segs = document.querySelectorAll("#segments .seg");
          segs.forEach((el, i) => {
            el.style.borderColor = i === cursor ? "#33d1ff" : "#2a3968";
            el.style.boxShadow =
              i === cursor ? "0 0 0 1px #33d1ff inset" : "none";
          });
        }

        function beep() {
          try {
            const a = new (window.AudioContext || window.webkitAudioContext)();
            const o = a.createOscillator(),
              g = a.createGain();
            o.type = "sine";
            o.frequency.value = 880;
            o.connect(g);
            g.connect(a.destination);
            g.gain.setValueAtTime(0.001, a.currentTime);
            g.gain.exponentialRampToValueAtTime(0.2, a.currentTime + 0.01);
            o.start();
            setTimeout(() => {
              g.gain.exponentialRampToValueAtTime(0.001, a.currentTime + 0.18);
              o.stop(a.currentTime + 0.2);
            }, 180);
          } catch (e) {}
        }

        function tick() {
          if (!running) return;
          if (totalSec <= 0) {
            finishBike();
            return;
          }
          totalSec--;
          segRemain--;
          const clockEl = document.querySelector("#clock");
          if (clockEl) clockEl.textContent = fmt(totalSec);

          // 3åˆ†ã”ã¨ã«éŸ³ã‚’é³´ã‚‰ã™
          if (totalSec > 0 && totalSec % 180 === 0) {
            beep();
          }

          if (segRemain <= 0) {
            cursor++;
            if (cursor < plan.length) {
              segRemain = plan[cursor].sec;
              highlightSeg();
              beep();
            }
          }
        }

        function startTimer() {
          if (running) return;
          if (totalSec <= 0) loadPlan();
          running = true;
          timer = setInterval(tick, 1000);
        }

        function pauseTimer() {
          running = false;
          if (timer) clearInterval(timer);
        }

        function resetTimer() {
          pauseTimer();
          loadPlan();
        }

        async function finishBike() {
          pauseTimer();
          const clockEl = document.querySelector("#clock");
          if (clockEl) clockEl.textContent = "å®Œäº†ï¼";
          const bikeDoneEl = document.querySelector("#bikeDone");
          if (bikeDoneEl) {
            bikeDoneEl.checked = true;
            await mark("bikeDone", true);
          }
          beep();
          setTimeout(beep, 220);
        }

        // ã‚¿ã‚¤ãƒãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        const startBtn = document.querySelector("#start");
        const pauseBtn = document.querySelector("#pause");
        const resetBtn = document.querySelector("#reset");

        if (startBtn) startBtn.addEventListener("click", startTimer);
        if (pauseBtn) pauseBtn.addEventListener("click", pauseTimer);
        if (resetBtn) resetBtn.addEventListener("click", resetTimer);

        loadPlan();

        // === ãƒ—ãƒ©ãƒ³ã‚¯30ç§’ã‚¿ã‚¤ãƒãƒ¼ ===
        const plank30Btn = document.querySelector("#plank30");
        if (plank30Btn) {
          plank30Btn.addEventListener("click", () => {
            plank30Btn.disabled = true;
            plank30Btn.textContent = "â³ 30ç§’";
            let s = 30;
            const t = setInterval(() => {
              s--;
              plank30Btn.textContent = `â³ ${s}ç§’`;
              if (s <= 0) {
                clearInterval(t);
                beep();
                plank30Btn.textContent = "â–¶ 30ç§’ã‚¿ã‚¤ãƒãƒ¼";
                plank30Btn.disabled = false;
              }
            }, 1000);
          });
        }

        // === é€£ç¶šæ—¥æ•°ï¼ˆã‚¹ãƒˆãƒªãƒ¼ã‚¯ï¼‰ç®¡ç† ===
        function updateStreak() {
          const LSKEY = (suffix) => `bootcamp.${suffix}`;
          const keyBase = () => new Date().toISOString().slice(0, 10);

          const last = localStorage.getItem(LSKEY("lastOpen"));
          const today = keyBase();

          if (last !== today) {
            // æ–°ã—ã„æ—¥ - æ˜¨æ—¥ã®å®Ÿç¸¾ã‚’ãƒã‚§ãƒƒã‚¯
            const yKey = new Date(Date.now() - 86400000)
              .toISOString()
              .slice(0, 10);
            const yState = JSON.parse(
              localStorage.getItem(`bootcamp.${yKey}.state`) || "{}"
            );
            const had =
              yState.bikeDone || yState.strengthDone || yState.stretchDone;

            let streak = Number(localStorage.getItem(LSKEY("streak")) || "0");
            if (had) {
              streak = streak + 1;
            } else {
              streak = 0;
            }

            localStorage.setItem(LSKEY("streak"), String(streak));
            localStorage.setItem(LSKEY("lastOpen"), today);
          }

          // ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¡¨ç¤ºã‚’æ›´æ–°
          const streak = Number(localStorage.getItem(LSKEY("streak")) || "0");
          const streakEl = document.querySelector("#streak");
          if (streakEl) streakEl.textContent = streak;
        }

        updateStreak();
      })();

      // === é€²æ—ãƒãƒ£ãƒ¼ãƒˆæ©Ÿèƒ½ ===
      (function () {
        let progressChart = null;

        // ãƒãƒ£ãƒ¼ãƒˆã®åˆæœŸåŒ–
        function initChart() {
          const ctx = document.getElementById("progressCanvas");
          if (!ctx) {
            console.error("[CHART] Canvas element not found");
            return;
          }

          // Chart.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if (typeof Chart === "undefined") {
            console.error("[CHART] Chart.js not loaded yet");
            setTimeout(initChart, 500); // 500mså¾Œã«å†è©¦è¡Œ
            return;
          }

          console.log("[CHART] Initializing chart...");

          const config = {
            type: "line",
            data: {
              labels: [],
              datasets: [
                {
                  label: "é€²æ—ç‡ (%)",
                  data: [],
                  borderColor: "#6ee7ff",
                  backgroundColor: "rgba(110, 231, 255, 0.1)",
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4,
                  pointBackgroundColor: "#6ee7ff",
                  pointBorderColor: "#ffffff",
                  pointBorderWidth: 2,
                  pointRadius: 6,
                  pointHoverRadius: 8,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                title: {
                  display: true,
                  text: "é€²æ—å®Ÿç¸¾ãƒãƒ£ãƒ¼ãƒˆ",
                  color: "#eaf1ff",
                  font: {
                    size: 16,
                    weight: "bold",
                  },
                },
                legend: {
                  labels: {
                    color: "#eaf1ff",
                  },
                },
              },
              scales: {
                x: {
                  ticks: {
                    color: "#b6c2e1",
                  },
                  grid: {
                    color: "rgba(182, 194, 225, 0.1)",
                  },
                },
                y: {
                  beginAtZero: true,
                  max: 100,
                  ticks: {
                    color: "#b6c2e1",
                    callback: function (value) {
                      return value + "%";
                    },
                  },
                  grid: {
                    color: "rgba(182, 194, 225, 0.1)",
                  },
                },
              },
              interaction: {
                intersect: false,
                mode: "index",
              },
            },
          };

          try {
            progressChart = new Chart(ctx, config);
            console.log("[CHART] Chart initialized successfully");
          } catch (error) {
            console.error("[CHART] Error initializing chart:", error);
          }
        }

        // é€±é–“ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨è¡¨ç¤º
        async function showWeeklyChart() {
          if (!progressChart) {
            console.error("[CHART] Chart not initialized for weekly view");
            return;
          }

          try {
            const response = await fetch("/api/logs");
            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }
            const logs = await response.json();

            // workoutè¨˜éŒ²ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const workoutLogs = logs.filter((log) => log.action === "workout");

            // éå»7æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ï¼ˆåŒæ—¥è¤‡æ•°ä»¶ã¯æœ€å¤§é€²æ—ã‚’æ¡ç”¨ï¼‰
            const today = new Date();
            const weeklyData = [];
            const labels = [];

            for (let i = 6; i >= 0; i--) {
              const date = new Date(today);
              date.setDate(date.getDate() - i);
              const dateStr = date.toISOString().slice(0, 10);
              const displayDate = date.toLocaleDateString("ja-JP", {
                month: "2-digit",
                day: "2-digit",
              });

              // å½“æ—¥åˆ†ã®å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ï¼ˆYYYY-MM-DD ã¨ YYYY-MM-DD-<n> ã‚’å¯¾è±¡ï¼‰
              const dayLogs = workoutLogs.filter((log) => {
                const key = String(
                  log.dateKey || (log.date ? log.date.slice(0, 10) : "")
                );
                return key === dateStr || key.startsWith(dateStr + "-");
              });

              const progress = dayLogs.length
                ? Math.max(...dayLogs.map((l) => Number(l.progress) || 0))
                : 0;

              labels.push(displayDate);
              weeklyData.push(progress);
            }

            progressChart.data.labels = labels;
            progressChart.data.datasets[0].data = weeklyData;
            progressChart.options.plugins.title.text =
              "é€±é–“é€²æ—ãƒãƒ£ãƒ¼ãƒˆï¼ˆéå»7æ—¥é–“ï¼‰";
            progressChart.update();
          } catch (error) {
            console.error("[CHART] é€±é–“ãƒãƒ£ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:", error);
            alert("é€±é–“ãƒãƒ£ãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        }

        // æœˆé–“ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨è¡¨ç¤º
        async function showMonthlyChart() {
          if (!progressChart) {
            console.error("[CHART] Chart not initialized for monthly view");
            return;
          }

          try {
            const response = await fetch("/api/logs");
            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }
            const logs = await response.json();

            const workoutLogs = logs.filter((log) => log.action === "workout");

            // éå»30æ—¥é–“ï¼ˆåŒæ—¥è¤‡æ•°ä»¶ã¯æœ€å¤§é€²æ—ã‚’æ¡ç”¨ï¼‰
            const today = new Date();
            const monthlyData = [];
            const labels = [];

            for (let i = 29; i >= 0; i--) {
              const date = new Date(today);
              date.setDate(date.getDate() - i);
              const dateStr = date.toISOString().slice(0, 10);
              const displayDate = date.toLocaleDateString("ja-JP", {
                month: "2-digit",
                day: "2-digit",
              });

              const dayLogs = workoutLogs.filter((log) => {
                const key = String(
                  log.dateKey || (log.date ? log.date.slice(0, 10) : "")
                );
                return key === dateStr || key.startsWith(dateStr + "-");
              });

              const progress = dayLogs.length
                ? Math.max(...dayLogs.map((l) => Number(l.progress) || 0))
                : 0;

              labels.push(displayDate);
              monthlyData.push(progress);
            }

            progressChart.data.labels = labels;
            progressChart.data.datasets[0].data = monthlyData;
            progressChart.options.plugins.title.text =
              "æœˆé–“é€²æ—ãƒãƒ£ãƒ¼ãƒˆï¼ˆéå»30æ—¥é–“ï¼‰";
            progressChart.update();
          } catch (error) {
            console.error("[CHART] æœˆé–“ãƒãƒ£ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:", error);
            alert("æœˆé–“ãƒãƒ£ãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        document.addEventListener("DOMContentLoaded", function () {
          console.log(
            "[CHART] DOM Content Loaded, initializing chart system..."
          );

          // Chart.jsã®èª­ã¿è¾¼ã¿ç¢ºèªå¾Œã«ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–
          setTimeout(() => {
            initChart();

            // ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–å¾Œã«é€±é–“ãƒãƒ£ãƒ¼ãƒˆã‚’è¡¨ç¤º
            setTimeout(() => {
              if (progressChart) {
                console.log("[CHART] Starting default weekly chart...");
                showWeeklyChart();
              }
            }, 500);
          }, 100);

          // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
          const weeklyBtn = document.getElementById("weeklyChart");
          const monthlyBtn = document.getElementById("monthlyChart");
          const refreshBtn = document.getElementById("refreshChart");

          if (weeklyBtn) {
            weeklyBtn.addEventListener("click", () => {
              console.log("[CHART] Weekly button clicked");
              showWeeklyChart();
            });
          }
          if (monthlyBtn) {
            monthlyBtn.addEventListener("click", () => {
              console.log("[CHART] Monthly button clicked");
              showMonthlyChart();
            });
          }
          if (refreshBtn) {
            refreshBtn.addEventListener("click", () => {
              console.log("[CHART] Refresh button clicked");
              // ç¾åœ¨è¡¨ç¤ºä¸­ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
              if (progressChart) {
                const currentTitle = progressChart.options.plugins.title.text;
                if (currentTitle.includes("æœˆé–“")) {
                  showMonthlyChart();
                } else {
                  showWeeklyChart();
                }
              }
            });
          }
        });
      })();
    </script>

    <!-- BGMã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å‰Šé™¤æ¸ˆã¿ -->
  </body>
</html>
